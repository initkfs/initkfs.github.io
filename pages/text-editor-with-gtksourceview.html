<!doctype html>
<html lang="ru">
<head>
    <meta charset='utf-8'>
    <meta name="yandex-verification" content="7021eeb9c07b5c09">
    <meta name="google-site-verification" content="PztbVe6Ru8ggM2n_tWUYwy0bEVHtJNvzIr-nsVCvBCA">
    
    
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <!-- favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/stab/img/favicons/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/stab/img/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/stab/img/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/assets/stab/img/favicons/safari-pinned-tab.svg" color="#004245">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/stab/img/favicons/apple-touch-icon.png">
    <meta name="msapplication-config" content="/assets/stab/img/favicons/browserconfig.xml">
    <!-- end favicons -->
    <!-- rss feeds -->
    <link rel=alternate title="RSS лента" type=application/rss+xml href='/rss-all.xml'>
    <!-- end rss feeds -->
    <link type="text/plain" rel="author" href="/humans.txt">
    <link crossorigin='anonymous' href='https://cdn.materialdesignicons.com/3.5.95/css/materialdesignicons.min.css'
          integrity='sha384-Ls5zBitvvQ/wdeZDuTUevSY5Tb/she50BeMPrco2ok6xDC8modj6/JPwdL0gNxmP' rel='stylesheet'>
    
    <link crossorigin='anonymous' integrity='sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=='
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    
    <link href="/assets/dev/css/main.css" rel='stylesheet'>
    
    <title>Текстовый редактор на основе GtkSourceView. Космическая станция Аналитики - DIY техноблог о сложных IT-проектах</title>
    <meta name="description" content="Эксперимент с gtkd и GtkSourceView">
    <meta content='Текстовый редактор на основе GtkSourceView. Космическая станция Аналитики - DIY техноблог о сложных IT-проектах' property='og:title'>
    
    <meta name="keywords" content="text editor,dlang,gtkd,gtk,webkit,vte">
    
    <meta content='/index.html' property='og:url'>
    <meta content='website' property='og:type'>
    <meta content='ru_RU' property='og:locale'>
</head>
<body>
<div class='container mb-3'>
    <div class='row'>
        <div class='col-lg-12'>
           <div class='card w-100 site-header-container'>
    <div class='row align-items-center'>
        <div class="col-lg-9">
            <div class='card-header site-header'>
                <div class='card-title site-header-title mb-3'>
                    <h5 class='site-header-title-text'>
                        <a href='/index.html' class='blog-title-text-link'>Космическая станция Аналитики - DIY техноблог о сложных IT-проектах</
                    </h5>
                </div>
                <div class='card-subtitle site-header-subtitle mb-2'>
                     <a href="/pages/about.html" class="badge mb-2 mb-sm-0">О станции и капитане</a>  <a href="/pages/site-implementation.html" class="badge">Сайт (Groovy-генератор)</a> 
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            
            <div class='site-map w-100 d-flex justify-content-center pe-lg-3'>
                <a class='site-map-link btn w-100' href='/site-map.html' role='button'><span
                        class='site-map-link-icon mdi mdi-sitemap'></span>
                    <span class='text-clarification'>Карта сайта (все статьи)</span></a>
            </div>
            
        </div>
    </div>
</div>
        </div>
    </div>
</div>
<div class='container'>
    <div class='row'>
        <div class='col-lg-9 blog-posts'>
            <article class='card post'>
    <h5 class='card-header post-header fw-bold'>
        Текстовый редактор на основе GtkSourceView
    </h5>
    <div class='card-body post-body'>
        <div class="card-title mb-3">
            <div class="post-body-header">

<div class='post-header-date'><span class='mdi mdi-calendar-clock'></span>
    <span class="post-datetime-text" data-iso-time="2022-04-17">17 апреля 2022</span>
</div>



<div class='post-labels'>
    <span class='post-header-labels-icon mdi mdi-tag-outline'></span>
    
    <a class='post-label-item badge font-weight-normal'
       href='/tags/dlang.html' rel='tag'>Dlang
    </a>
    
</div>
</div>
        </div>
        <div class='post-content'><p>Библиотека <a href="https://wiki.gnome.org/Projects/GtkSourceView">GtkSourceView</a> уже давно привлекала меня своими возможностями, коих заявлено немало: подсветка синтаксиса множества языков, темы оформления, автоотступы, повтор и отмена редактируемого текста, автодополнение, загрузка и сохранение файлов, номера строк, мини-карта навигации по тексту и прочее всякое разное.</p>
<p>Эксперимент с ней выглядит интересным и полезным, а разработку облегчат прекрасные объектные биндинги GtkD, всё-таки не с gap-буферами возиться. Из коробки биндинги уже есть в субпакете gtk-d:sv, но завязаны они на 4 версию библиотеки, а она есть не во всех дистрибутивах, что понижает портабельность, так что экспериментировать пришлось с 3. Поговаривают, что часть ошибок в ней исправили, в списке изменений есть исправление утечек памяти, api различаются незначительно (но местами всё-таки различаются). Практически всю общую логику можно реиспользовать из предыдущего эксперимента с <a href="/pages/rss-aggregator-and-gtkd.html">RSS-ридером</a>, что также сэкономит время на разработку, синхронизируя архитектуры программ, позволив их сопровождать с меньшей болью.</p>
<p>Текстовый редактор - классика софтостроения, но как и любой другой софт он должен чем-то выделяться из массы конкурентов, иначе проще взять уже готовую и протестированную программу, а весь эксперимент теряет всякий смысл. В дикой природе встречается огромнейшее количество разных текстовых редакторов, начиная от консольных и заканчивая развитыми GUI-интерфейсами, здесь нужно задуматься об общем концепте проекта и его месте среди других.</p>
<p>Любые требования к программе нужно с чем-то сравнивать, поэтому я выберу основным эталоном <a href="https://www.geany.org">Geany</a>, посматривая одним глазом на Notepad++, PSPad, а также на уже существующие редакторы (Gedit, Xed и т.д.) с GtkSourceView на борту. На самом деле основной функционал более-менее везде одинаков, различаясь в зависимости от специализации редактора.</p>
<p>В первую очередь логично обосновать выбор GtkD для данной программы, ведь текстовый редактор можно построить на любом более-менее популярном тулките. Для Swing есть <a href="https://github.com/bobbylight/RSyntaxTextArea">RSyntaxTextArea</a>, которую я испытывал в эксперименте с <a href="/pages/russian-dsl-on-groovy.html">русскоязычным DSL</a>, для JavaFX - <a href="https://github.com/FXMisc/RichTextFX">RichTextFX</a>. С последней эксперименты были очень поверхностными, но с простыми задачами она вроде как справляется, хотя потестировать серьёзнее её бы не помешало.</p>
<p>Однако эти примеры тулкитов высоких уровней абстракции. С одной стороны, стабильность и надёжность программы будет возрастать, с другой - общее устройство усложняется, какие-то метрики производительности могут ухудшаться, как и усложнится интеграция с системой. Время запуска редактора предполагается в несколько секунд, показатели у конкурентов очень высокие, что выглядит критичным. К тому же виртуальные машины могут создать много сложностей по управлению процессом, настройке привилегий и прочему администрированию, плавно намекая на компиляцию в натив. Теоретически, ухудшение производительности можно компенсировать возможностями редактора, используя всю мощь высокоуровневых языков, но это уже скорее программа совершенно другого класса, а там уже другие конкуренты.</p>
<p>Следовательно, для данного эксперимента системный язык и тулкит на нём выглядит более удобным и подходящим (среди тех технологий, которые мне интересны и которые я активно использую, конечно же). Насколько выгодно использовать именно D? С одной стороны, отсутствие популярности и малое количество библиотек создаёт определённые риски, с другой - позволяет приблизить архитектуру к конкурентным тулкитам на более высокоуровневых языках, что выглядит балансным решением, а недостаток библиотек можно частично компенсировать биндингами, как и легко исправлять ошибки в уже существующих за счёт общей простоты их строения.</p>
<p>Теоретически, такой редактор с GtkSourceView вполне можно было бы сделать даже на Dart, учитывая недавний <a href="/pages/experiment-dart-and-gtk.html">эксперимент с GTK</a>, поскольку Flutter проявил свою специализацию на мобайле, а данная задача требует десктопной специализации. Но из-за отсутствия готовых биндингов затея выглядит сомнительной, ибо в намного более высокоуровневом Dart резко осложняется взаимодействие с низкоуровневым кодом через ffi.</p>
<p>Поэтому бегло можно оценить основные риски на данном этапе для GtkD по всем известной <strong>FURPS</strong>:</p>
<p><strong>Functionality (Функциональные требования)</strong>: из-за наличия готовой библиотеки, развитого std у D и возможности использования системных библиотек выглядит возможным повторить большую часть функционала.</p>
<p>С другой стороны, какая-то его часть будет системозависимой, нужно будет найти кроссплатформенный аналог (например, для терминала), а также подстраховаться условной компиляцией на случай проблем с библиотеками и портированием на другие платформы. Могут быть проблемы с различными кодировками и прочими специфическими для разных систем вещами, но они сохранятся скорее для любого тулкита, относясь к предметной области работы с текстом.</p>
<p>А вот <a href="https://ru.wikipedia.org/wiki/Сворачивание_(программное_обеспечение)">фолдинг</a> из коробки не поддерживается (по крайней мере в моей версии библиотеки). С одной стороны, для данной задачи мне он особенно и не нужен, с другой - это выглядит всё таки важным отсутствующим функционалом, который нужно <a href="https://stackoverflow.com/questions/10924998/code-folding-in-gtksourceview">реализовывать самому</a>, что для подобного редактора выглядит сомнительной тратой времени. К тому же помимо управления видимостью блоков кода нужна корректная работа всех основных действий с текстом (копировать, вырезать, вставить и т.п.), а это далеко не во всех редакторах нормально реализовано, что намекает на ещё большее увеличение потерь времени.</p>
<p><strong>Usability</strong>: GTK хотя и своеобразен по юзабилити, но вполне терпим. Однако тут тоже появляется риск: из-за больших отступов в некоторых темах и рабочих столах панели занимают очень много места и нужно скомбинировать их таким образом, чтобы уменьшить потребление пространства. Это намекает на объединение привычного главного меню программы с большими кнопками, чтобы исключить отдельные тулбары для кнопок, однако обратной стороной такого решения может быть усложнение навигации из-за сложившихся когнитивных привычек.</p>
<p>Есть ещё проблема с очень ограниченным набором дефолтных иконок, когда как именно их использование сильно ускоряет и упрощает построение интерфейса. В некоторых случаях нужно притягивать за уши смысл иконки к действию, иконографика становится очень условной, но для простых случаев с этим можно смириться, ну или добавлять что-то своё после стабилизации интерфейса.</p>
<p><strong>Reliability (Надёжность)</strong>: с одной стороны, часть отказов подстраховано исключениями. Но в архитектуре разделения приложения на контроллеры в самом простом случае есть большое количество мест взаимодействия делегатами-коллбэками, которые вполне могут быть null, в случае неаккуратного с ним обращения будет беда. Хотя и есть некоторые способы подстраховок, но обращение к таким коллбэкам вполне контролируемо, поэтому можно начать без nullable-обёрток.</p>
<p>Большой риск представляет вылет исключения из обработчика событий, что может привести к обходу ими глобальный системы перехвата ошибок в программе, с другой стороны - логика текстового редактора относительно проста. Вероятно, показатели надёжности будут где-то посередине между чисто системным стеком и прикладным, опасность представляет лишь часть ошибок, заканчивающиеся сегфолтом, что опять-таки отсылает к балансному решению между языками разного уровня абстракции. Для программы класса текстового редактора это выглядит терпимым и подходящим.</p>
<p>Ещё одним риском может быть поведение D <a href="https://forum.dlang.org/thread/prwrnbquewqkliqsassi@forum.dlang.org">для символических ссылок</a>. Симлинк может успешно пройти std.file.exists на следующей проверке std.file.isFile и isDir выбросится исключение, как и при любом доступе к такому файлу, что может сделать редактор более хрупким и есть смысл лишний раз протестировать открытие симлинков с отсутствующим файлом.</p>
<p><strong>Performance (Производительность)</strong>: в общем и целом системность языка способна отвечать минимальным требованиям (часть из которых субъективны) производительности, однако в работе некоторых алгоритмов всё равно могут быть проблемы, но их более легко локализовать и исправить. Вероятно, более зрелые редакторы обогнать не выйдет из-за сильно оптимизированных алгоритмов и открытие очень больших файлов может представлять проблему, с другой стороны, как указано выше, программа не относится к простому текстовому редактору, выбирая более специализированный путь, так что проседание производительности в любом случае скорее всего будет за счёт функционала, архитектуры (переноса вью в xml) и прочего.</p>
<p>Скорее основной риск тут представляют <a href="https://stackoverflow.com/questions/60031620/loading-big-files-into-gtksourceview-is-slow">проблемы больших файлов в самой библиотеке</a>. При тестировании эта постепенная загрузка создаёт и проблемы в работе мини-карты, которая постоянно елозит туда-сюда. Но опять-таки, возможно, тут виновата старая версия библиотеки, а для очень больших файлов и так есть смысл брать что-то специально под них заточенное.</p>
<p>Ещё одна проблема может быть из сборщика мусора, без управления которым память программа отдавать системе обратно не торопится. Если же расставить вызовы GC.collect и GC.minimize после закрытия табов и в прочих ключевых местах, то всё становится получше и больше похоже на обращение с памятью конкурентов.</p>
<p><strong>Supportability (Поддержка)</strong>: если использовать инжекцию контролов через метапрограммирование в поля контроллеров, то архитектура начинает приближаться к более высокоуровневым тулкитам.</p>
<p>Можно проанализировать как влияет тулкит на некоторые отдельные характеристики поддержки.</p>
<p>Возможность поддержки, ремонтопригодность: относительно высокая из-за объектно-ориентированной парадигмы, в случае соблюдения классических паттернов баги достаточно легко локализовать даже простым комментированием, не прибегая к дебаггеру, который по тем или иным причинам может быть проблемен или работать плохо. Иерархичность также благосклонна к условной компиляции и облегчает включение и отключение функционала в разных версиях.</p>
<p>Гибкость, модифицируемость: тоже высокая из-за разделения кода и выноса вью в xml с Glade. Может быть проблемой перезапутывание логики взаимодействия между разными контроллерами и слоями приложения, но появление её ситуативно.</p>
<p>Модульность, расширяемость: возможна в разных вариантах, например, посредством плагинов и Lua-биндингов, как и других встраиваемых языков или систем (например, <a href="https://wiki.gnome.org/Projects/Libpeas">Libpeas</a>). В данном случае есть полный доступ к кодовой базе, а значит проще внести изменения в сам код, чем использовать какие-то плагины и модули.</p>
<p>Локализация: это уже интереснее. Можно попробовать <a href="https://stackoverflow.com/questions/10094335/how-to-bind-a-text-domain-to-a-local-folder-for-gettext-under-gtk3">что-то такое через gettext</a>, однако это не выглядит удобным. Собственное решение выглядит более универсальным, но потребует переустановки всех текстов во вью, что вполне реализуемо, однако по затратам времени в рамках эксперимента выглядит одинаково сомнительно.</p>
<p>Кроссплатформенность: GTK предполагает определённую кроссплатформенность, однако из-за части системозависимого кода и библиотек портативность может осложняться в зависимости от функционала самого редактора.</p>
<p>Портативность: теоретически, можно настроить загрузку всех библиотек из директории с программой, что скорее более актуально для Windows-систем, такие эксперименты я проводил лишь под Wine, но не в полном объёме.</p>
<p>По итогам выглядит, что GtkD способен справиться с этим проектом и решить большую часть из потенциальных задач, а риски выглядят обычными как для любой IT-технологии. Тогда пришло время определиться с функциональными требованиями.</p>
<p>В глаза бросается сильная универсальность конкурентов, предназначенных для перемалывания самых разных файлов. Отсюда есть смысл сделать что-то среднее: оставить возможность работы с простыми файлами, так и немного специализировать редактор для узких задач, занимая таким образом промежуточное место между самым простым редактором и более сложными для работы с кодом, но ещё и не IDE (например, что-то вроде ещё более простых программ, чем программы класса vscode).</p>
<p>Что может быть в этой промежуточной нише... можно бегло подумать над вариантами использования и списком требований, примерно представив концепт программы. Обычный текстовый редактор хорошо выполняет разные операции над файлами, однако стремление к IDE требует тоже самого и для директорий. Можно взять распространённую задачу - быстрое изучение кода в директории склонированного репозитория. Просмотр файлов должен быть максимально быстрым, что намекает на выдвижную панель файлового браузера, как у многих IDE - слева.</p>
<p>Поскольку текстом представлен код, то в процессе изучения могут быть полезными сниппеты. Для работы сниппетов наличие отдельной правой панели выглядит не только удобством, а уже необходимостью, сниппеты нужно не только сохранять, но и вставлять. Отсутствие панели заставило бы либо запоминать какие-то мнемоники, либо выводить плавающее окно, диалог или какой-то список, что выглядит более сложным как технически, так и для юзабилити.</p>
<p>В итоге формируется двухпанельный концепт: слева файловый менеджер, справа панель инструментов. Обратной стороной такого подхода станут мешающие для повседневной простой работы панели. Поэтому обе нужно закрывать по клику кнопки или другим способом, делая интерфейс минималистичным. Раз панели закрываются, то туда должен добавляться менее часто используемый функционал.</p>
<p>Однако код можно не только читать, но и запускать, что намекает на терминал и ещё одну панель снизу. Это отражает промежуточное положение между редактором и IDE, позволяя заниматься скриптописью, например, на Bash. Со сниппетами, быстрым запуском скрипта в терминале это выглядит удобным.</p>
<p>Для меня появляется ещё одно важное требование - поддержка <a href="https://ru.wikipedia.org/wiki/Markdown">Markdown</a>. У Markdown не слишком много конкурентов, даже статьи этого блога оформляются в нём, достаточно странно, чтобы редактор его не поддерживал, однако это предполагает и встраивание браузера для проверки результата. Этот же браузер можно использовать для просмотра документации, как языка так и сервисов вроде <a href="https://devdocs.io">devdocs.io</a>.</p>
<p>Подведём небольшие итоги по концепту редактора и макета:</p>
<ul>
<li>Панель с файловым браузером слева.</li>
<li>Панель инструментов справа.</li>
<li>Панель терминала снизу.</li>
</ul>
<p>Конечно же, в панели можно помещать всё что угодно, да и как угодно, список выше скорее обосновывает лишь их удобство и необходимость. Вероятно, всё будет эволюционировать в направлении перетаскивания вкладок между разными панелями, однако у меня был печальный опыт построения такого интерфейса на другом тулките: это требует много времени и много сложности, когда как в результате эксплуатации положение панелей фиксируется и входит в привычку, а их переключение и перетаскивание никому не нужно. Учитывая лёгкую возможность правки через Glade и небольшое количество функционала, перетаскивание выглядит в данном случае немного сомнительной затеей.</p>
<p>Минимальный функционал можно подсмотреть на любом сайте аналога, однако для каждого редактора приоритеты будут разными. Несоблюдение на первый взгляд дополнительного функционала: сниппетов, Markdown, браузера и т.п., сводит на нет любые преимущества в использовании: всё выглядит как очередной клон без какой-либо дополнительной пользы, а значит лучше взять что-нибудь другое. Кроме того, многие требования субъективны и зависят от пользователя.</p>
<p>Можно подвести небольшие итоги по функционалу, используя MoSCoW метод, однако в рамках эксперимента перечисление всего возможного функционала потребовало бы огромных списков, ограничусь самым основным, например:</p>
<p>Must have (критичный функционал):</p>
<ul>
<li>Открытие и закрытие файлов в табах.</li>
<li>Открытие файла перетаскиванием в окно программы.</li>
<li>Сохранение файла по сочетанию клавиш и через диалог, возможность перемещения курсора клавишами.</li>
<li>Поиск, подсветка и замена текста в т.ч. по регулярным выражениям.</li>
<li>Контекстное меню с основными действиями: вырезать, копировать, вставить и т.п.</li>
<li>Повтор и отмена, номера строк, перенос.</li>
<li>Подсветка синтаксиса.</li>
<li>Вывод информации о файле: кодировка, тип переноса строки, MIME-тип файла, количество строк и символов.</li>
</ul>
<p>Should have (важный):</p>
<ul>
<li>Создание файла из шаблонов (например, <a href="https://www.freedesktop.org/wiki/Software/xdg-user-dirs/">xdg-user-dirs</a>)</li>
<li>Монитор открытого файла, перегрузка по изменениям.</li>
<li>Механизм сессий и восстановление открытых файлов.</li>
<li>Открытие новых файлов в том же окне уже работающей программы.</li>
<li>Анализ файла на безопасность (например, на <a href="https://habr.com/ru/news/t/587072/">Trojan Source с CVE-2021-42574</a>).</li>
<li>Автодополнение.</li>
<li>Поддержка сниппетов.</li>
<li>Markdown.</li>
<li>Файловый менеджер.</li>
<li>Терминал.</li>
<li>Браузер.</li>
</ul>
<p>Could have (желательный):</p>
<ul>
<li>Быстрый переход вверх и вниз документа.</li>
<li>Настройка шрифтов и цветов.</li>
<li>Список недавно открытых файлов.</li>
<li>Проверка орфографии.</li>
<li>Печать.</li>
</ul>
<p>Would to have (опциональный):</p>
<ul>
<li>Разные дополнения и улучшения, перечислять которые в рамках эксперимента избыточно: вставка даты и времени, сортировка строк и т.п.</li>
</ul>
<p>Напомню, что этот принцип отражает важность, а не очерёдность. Поэтому начинать всегда есть смысл с потенциально проблемного функционала, баг или затык в котором способен похоронить проект. В данном случае это api самой библиотеки GtkSourceView, работа с её буфером, поиск и замена текста и т.п. Любой блокирующий баг или проблема в такой логике ведёт к сильному ухудшению конкурентоспособности редактора, как следствие - проще завершить эксперимент и взять что-нибудь другое. Понятно, что чем раньше эта проблема вскроется - тем лучше.</p>
<p>Как всегда, библиотеки - основной источник рисков и проблем в т.ч. при переносе программы на другие операционные системы. Без GtkSourceView редактор не может работать, как и без самого GTK, а вот без терминала, орфографии, автоопределения кодировок и браузера вполне остаётся работоспособным. При портировании программы или в случае её портабельного варианта достаточно обидно получить неработоспособную версию из-за дополнительного функционала. Отсюда все эти функции логично версионировать для <a href="https://dlang.org/spec/version.html">условной компиляции</a>. В версионировании нуждается, по крайней мере, терминал, орфография, определение кодировок  и браузер из-за привязки к библиотекам.</p>
<p>Из Geany особенно удобны кнопки создания нового файла и список недавно открытых файлов. Рядом с ними было решено добавить ещё две полезные кнопки - навигация по документу вверх и вниз до конца, что иногда часто требуется и достаточно удобно. С сожалению, этот концепт нарушает когнитивную привычку искать пункт меню &quot;Файл&quot; на самом краю главного меню, поэтому пришлось их вынести в совсем другую сторону и подальше.</p>
<p>Функционал автосохранения хотя и полезен, но на любителя: привычка частого сохранения хоткеями выработалась годами, а вот автосохранение способно сохранить то, что не нужно. Встраивание SSH в рамках эксперимента тоже выглядит специализированным, как и удалённое открытие документов и прочее, его я не рассматриваю. Разноцветные табы смотрятся красиво, но привыкание к одноцветным табам разных IDE и браузеров скорее также делает этот функционал специфическим.</p>
<p>Поддержка системы контроля версий может быть удобной, с другой стороны, простую информацию о ветках можно получать из терминала через приглашение командной стоки, тот же PS1, как и управлять из терминала вообще всем.</p>
<p>Прототип получился каким-то таким:</p>
<p><img alt='GtkD with GtkSourceView text editor' class='post-image' src='/assets/stab/img/posts/text-editor-with-gtksourceview/gtkd-gtksourceview-text-editor.png'></p>
<p>Бегло пробегусь по некоторым моментам реализации.</p>
<p>Табы можно легко реализовать через gtk.Notebook. Основные грабли скорее в закрытии таба, где есть шанс получить утечки, не разрушив все зависимые виджеты (можно предположить, что вызова removePage по индексу может быть достаточно, но это не так).</p>
<p>Для сниппетов выделена отдельная вкладка на правой панели, сами сниппеты в простых текстовых файлах, наверное больше всего полезны они для Bash, учитывая большое количество его граблей. Механизм сессий, как и список недавних файлов также самый простой обычными текстовыми файлами, всё по Unix-way.</p>
<p>В Gtk есть DnD (Drag and Drop), поэтому открытие файла перетаскиванием тоже не проблема.</p>
<p>Поиск, подсветка и замена текста проще через апи самой библиотеки (SourceSearchContext), там есть разные настройки, как и перемещение по результатам вперёд и назад. Подсветка результата по всему тексту также удобна. Поиск в отдельной правой панели по ощущениям намного удобнее поиска во всплывающих окнах и здесь наконец-то оказывается полезной мини-карта, на которой видны подсвеченные участки совпавшего с шаблоном текста. С другой стороны, эта мини-карта склонна раздражать при скролле самого текста и была убрана за это в GtkExpander.</p>
<p>В самой GtkSourceView большое количество разных настроек, проблему вызвало скорее разграничение спецсимволов, в Geany это сделано намного удобнее, но по беглому взгляду на реализации она выглядит захардкоженной. К тому же не было найдено удобного способа управлять символами переноса строки я решил немного усложнить себе жизнь, перехватывая нажатие клавиш, но это поломало автоотступ, который пришлось дополнительно вымучивать, ибо тамошняя документация к апи скорее располагает к обширным и долгим экспериментам, чем к быстрому решению задачи.</p>
<p>При работе с автодополнением помогли <a href="https://warroom.rsmus.com/do-that-auto-complete/">картинки из статьи</a>, по которым стала понятна причина - я тестировал на тегах html, предполагая, что он должен понимать попытку автокомплита содержимого тега, однако т.к. текст начинался не с &lt;, то и автодополнения не было. А вот кастомный провайдер так и не заработал, судя по всему там меняли апи и проще подождать нормальную версию библиотеки.</p>
<p>Работу с файлами библиотека тоже поддерживает, но я решил отдать этот функционал другим, всё-таки есть опасение наделить библиотеку слишком большой ответственностью в части работы с файлами и получить отложенные архитектурные проблемы в будущем. Поэтому мониторинг файлов через gio.FileMonitor, анализ открываемых файлов берёт на себя std у D и сторонние библиотеки.</p>
<p>Если в выводимом окне об изменении файла добавить какую-нибудь CheckButton для автоматической перезагрузки файла при изменениях или разрешить её как-то по другому, то появляется функционал, напоминающий &quot;File Change Polling&quot;, встречается в некоторых редакторах, хотя он может подразумевать и проверки файла через фиксированные промежутки времени.</p>
<p>В сохранении есть случай - отсутствие свободного места на диске. У D есть функция std.file.getAvailableDiskSpace, её название может вводить в заблуждение, но на Posix системах она внутри использует вызов statvfs (для FreeBSD там немножко по-своему), а он возвращает информацию о смонтированной файловой системе.</p>
<p>Открытие новых файлов в запущенном приложении уже предусмотрено в Gtk, возможно через регистрацию делегата в методе Application.addOnOpen (приложению должен быть передан и флаг GApplicationFlags.HANDLES_OPEN), различать разные копии може специальным апи (например, getIsRemote и т.п.). При открытии бывают проблемы с долгим сохранением иконки загрузки на курсоре, но после тестов такое поведение оказалось и у других редакторов, возможно, тут влияет версия библиотек, дистрибутив и т.п. факторы. Также здесь появляется риск из-за каким-то образом оставшейся без открытого окна программы: любой новый открывающийся файл будет пытаться открываться в ней, блокируя запуск всех других копий, что без убийства основного процесса сделает программу неработоспособной в системе.</p>
<p>Терминал через библиотеку <a href="https://gitlab.gnome.org/GNOME/vte">vte</a>, готовые биндинги есть в субпакете <a href="https://code.dlang.org/packages/gtk-d:vte">gtk-d:vte</a>, с которой могут возникнуть проблемы под Windows, хотя, теоретически, её наверное можно найти во всяких MSYS2 и Cygwin. Для терминала имеет большое значение оформление, которое может отличаться от системного терминала и требовать либо какого-то отслеживания дефолтной темы, либо настройки. Я просто добавил кнопку переключения фона, поскольку разные задачи терминала удобно решать разными фонами.</p>
<p>Здесь есть нюанс в <a href="https://stackoverflow.com/questions/14459877/why-the-method-set-color-foreground-and-its-companions-set-color-xxx-dont-work">настройке оформления</a> vte, с толку может сбить сообщение об ошибке цвета: можно подумать, что его значение невалидно, однако ориентироваться нужно не по нему, а по ассерту о проверке цветов в палитре 0,8,16 и т.п., если размер неправильный, то оно и работать не будет. Неудобство здесь может быть из-за сброса стиля курсора, текста и прочего при изменении фона, но для простого случая не особенно критично.</p>
<p>Проверка орфографии через <a href="https://ru.wikipedia.org/wiki/Hunspell">hunspell</a>, биндинги там достаточно простые и легко реализуются вручную. Само окно проверки вынес в правую панель, поскольку поэтапная проверка орфографии в диалоге меня лично всегда раздражала в редакторах. Туда же была добавлена и отдельная проверка через <a href="https://github.com/hcodes/yaspeller">yaspeller</a>, проще всего запустить его через cli.</p>
<p>Что касается безопасности Trojan Source, то списки опасных символов можно найти в <a href="https://github.com/lirantal/anti-trojan-source/blob/main/src/constants.js">разных местах</a>, однако лучше сверять детектирование с другими популярными IDE и редакторами, например, тут отсутствует \u200b.</p>
<p>Также частным случаем могут быть невалидные символы в имени файла на разных системах, такое предупреждение реализуется весьма просто и выглядит полезным, особенно на Linux: много раз сталкивался с проблемами копирования файлов на носители с устаревшими и менее продвинутыми файловыми системами. Раз речь зашла о валидации имени, то концепт табов чувствителен к максимальной длине имени, Geany в случае превышения обрезает имя, что выглядит логичным, а, например, vscode - нет.</p>
<p>Распознавание кодировок через <a href="https://www.freedesktop.org/wiki/Software/uchardet/">uchardect</a>, апи там очень простое и тоже достаточно ручных биндингов. Полезно также обнаружение смешения разных переводов строк, что встречается достаточно редко. Но операции такого рода могут быть затратными и есть смысл добавить возможность отключения и включения в настройках или кнопкой.</p>
<p>Из коробки через std.encoding поддерживается перекодирование UTF-8\16\32, ASCII, ISO-8859-1 и 2, WINDOWS-1250\1251\1252 через функцию transcode. Не слишком много для редактора, но учитывая его задачи выглядит достаточным (так-то есть ещё iconv, конечно же), а для неизвестной кодировки проще вывести предупреждение или вопрос в диалоге, поскольку gtk тоже проверяет текст (вызывает Glib.utf8_validate и в буфер SourceBuffer его просто так не вставит). Вызовом функции getBOM можно определить маркер последовательности байтов. С учётом его опасности для скриптов есть смысл выводить предупреждение в случае его наличия.</p>
<p>Здесь также нужно учитывать логику чтения файла до перекодирования. Если будет вызов функции, которая делает какую-то валидацию текста, например, std.file.readText, то будут проблемы.</p>
<p>С другой стороны, автоматическое перекодирование и анализ файлов открывает множество векторов для атак на редактор, да и браузер тоже может повести себя по-разному, так что недоверенный код всё же безопаснее просматривать (и запускать) в более популярных IDE, уязвимости которых у всех на виду.</p>
<p>Поскольку кодировка и тип перевода строки может не совпадать с таковыми в редакторе, то в информационном тулбаре разделение их тоже показалось более удобным, да и проще определить, сработал ли автодетект кодировки и символа переноса строки, как сработал и т.д.</p>
<p>Для Markdown уже есть подсветка в т.ч. она пытается помечать некоторые теги. Для простых случаев этого вполне хватает, для более сложных - нужно ужё велосипедить что-то своё. Поскольку теги забываются, то само собой напрашивается простая панель с кнопками Markdown-тегов. Для конвертации в Markdown текста есть самые разные пакеты от более быстрых вроде <a href="https://code.dlang.org/packages/commonmark-d">commonmark-d</a> до более гибко настраеваемых и объектных <a href="https://code.dlang.org/packages/hunt-markdown">hunt-markdown</a>.</p>
<p>Браузер через <a href="https://webkitgtk.org">webkit2gtk</a>. Часть тулкитов переходит на Blink, но люди пишут, что биндинки к Webkit намного проще и стабильнее, да и подключить их намного легче. Для D можно найти пакеты, но в моём простом случае достаточно и самописных, расширенного функционала не требуется. Браузер создаёт определённые <a href="https://webkitgtk.org/security.html">риски для безопасности</a>, уязвимости всплывают периодически, что намекает на осторожное использование этого функционала.</p>
<p>Возможность работы с ресурсами навроде <a href="https://devdocs.io">DevDocs</a> поднимает вопрос портабельности программы: данные, которые сохраняет сайт для оффлайн-работы должны переноситься вместе с программой. Перенастроить директории можно с помощью <a href="https://webkitgtk.org/reference/webkit2gtk/stable/WebKitWebsiteDataManager.html">WebKitWebsiteDataManager</a>, однако если взять какой-нибудь пакет, например, <a href="https://code.dlang.org/packages/webkit2gtkd">webkit2gtkd</a>, то в нём только <a href="https://github.com/streaksu/webkit2gtkd/blob/752a7dec2e9fa58455834d5be3d5063edff6a4ce/source/webkit2/WebsiteDataManager.d#L94">пустой конструктор</a>, когда как настроить директории можно через вариативную функцию webkit_website_data_manager_new, передавая ей ключи и пути, да null последним.</p>
<p>Файловый менеджер самый простой с минимально необходимой навигацией и историей. Здесь в будущем может потребоваться вынос рутовой директории в отдельную вкладку, с другой стороны, возможны какие-то вкладки с проектом, навигацией по символам или что-то такое более полезное, а вот навигатор с множеством табов-директорий может быть избыточным. Набор файловых иконок <a href="https://github.com/redbooth/free-file-icons">free-file-icons</a>. Здесь основной вопрос с файловыми мониторами, без которых любой файловый менеджер сильно теряет в своей полезности, я использовал всё тот же gio.FileMonitor.</p>
<p>Для облегчения печати есть SourcePrintCompositor, однако документ упорно не хотел печататься в PDF и за примерами апи пришлось лезть в <a href="https://github.com/linuxmint/xed/blob/423f214a708b258a788c2feb0bcefb0711ed2fd6/xed/xed-print-job.c#L563">Xed</a>, после портирования логики всё заработало.</p>
<p>В общем и целом этого уже достаточно для выполнения минимальных задач редактором, а потенциал улучшения и добавления функционала потенциально бесконечен. Другой вопрос, что на каком-то этапе программа может стать похожей на клон какого-либо другого проекта, поэтому тут тоже нужен определённый баланс: сомнительно тратить время на редкий функционал, который можно использовать через другой редактор.</p>
<p>Какие итоги можно подвести. Несмотря на определённые проблемы и потери времени на борьбу с библиотекой, эксперимент можно признать успешным. Часть api не особенно интуитивна, но за счёт объектности биндингов в общем случае можно прийти к решению банальным перебором методов и разных их комбинаций, сообщения со стороны GTK также помогают сориентироваться, а решение проблем можно подсмотреть и в кодовой базе других редакторов, построенных на GtkSourceView. Так что было достаточно весело (в хорошем смысле этого слова) и мне этот эксперимент определённо понравился.</p>
</div>
    </div>
</article>
<div class='navigation-pages btn-toolbar justify-content-center mb-2' role='navigation'>
    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1'
       href='/pages/experiment-dart-and-gtk.html' role='button' rel="prev"> <span
            class='navigation-pages-link-icon mdi mdi-chevron-left'></span> Эксперимент с Dart №2, но вместо Flutter - GTK</a>
    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1' href='/index.html'
       role='button' rel="first">
        <span class='navigation-pages-link-icon mdi mdi-home'></span> Главная</a>

    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1'
       href='/pages/music-player-with-gstreamer-and-gtkd.html' role='button' rel="next">Эксперимент с GStreamer и GtkD <span
            class='navigation-pages-link-icon mdi mdi-chevron-right'></span></a>
    
</div>
        </div>
        <div class='col-lg-3 sidebar-right'>
            <div class='section' id='section-sidebar-right'>
    <div class='card sidebar-container post-labels'>
        <div class='card-header sidebar-container-header post-labels-header'>
            <span class='post-labels-header-icon mdi mdi-tag-outline'></span>
            Метки <span class='text-clarification'>(и кол-во статей)</span>
        </div>
        <div class='sidebar-container-content post-labels-content'>
            <div class='list-group list-group-flush'>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/dart.html'>Dart<span class='badge' style='min-width:40px;'>2</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/dlang.html'>Dlang<span class='badge' style='min-width:40px;'>3</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/groovy.html'>Groovy<span class='badge' style='min-width:40px;'>5</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/javafx.html'>JavaFX<span class='badge' style='min-width:40px;'>6</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/arhitektura_po.html'>Архитектура ПО<span class='badge' style='min-width:40px;'>10</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/metodologija.html'>Методология<span class='badge' style='min-width:40px;'>2</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/raznoe.html'>Разное<span class='badge' style='min-width:40px;'>1</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/ekonomika.html'>Экономика<span class='badge' style='min-width:40px;'>3</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/elektronika.html'>Электроника<span class='badge' style='min-width:40px;'>1</span></a>
                
            </div>
        </div>
    </div>
    <div class='card sidebar-container in-progress-articles'>
       <div class='card-header sidebar-container-header in-progress-articles-header'>
           <span class='mdi mdi-calendar-clock'></span>
            В процессе написания
       </div>
       <div class='sidebar-container-content post-labels-content in-progress-articles-content'>
               <ul class='list-group'>
				   <li class='list-group-item align-items-center text-muted'>Нет статей</li>
               </ul>
       </div>
    </div>
    <div class='card mb-3 sidebar-container links-contacts'>
        <div class='card-header sidebar-container-header links-contacts-header'>
            <span class='mdi mdi-open-in-new'></span>
            Девлоги текущих проектов
        </div>
        <div class="list-group sidebar-container-content">
			<a class='link-contact list-group-item list-group-item-action' rel="me" href='https://www.youtube.com/@initkfs'>Youtube (готовится)</a>
		</div>
    </div>
    <div class='page-up-wrapper'>
        <button class='btn d-none d-lg-block' id='page-up-trigger' type='button'><span
                class='mdi mdi-arrow-up'></span></button>
    </div>
</div>
        </div>
    </div>
</div>
<footer class='page-footer'>
    <div class='container'>
        <div class='row'>
            <div class='col-md-12'>
                <div class='card'>
    <div class='card-body'>
        <p class="text-danger">Сайт в процессе тестирования.</p>
        <small><span class='blog-info-footer'>Всего статей: 24. Блог - исследовательский, статьи отражают лишь субъективное мнение автора.</span> <span>&#169; <span id='copyright-date'></span>, Константин Фирсов.</span></small>
        
        <div class='blog-additional-links d-flex justify-content-center'>
        <div class='blog-rss'><a class='blog-rss-item blog-icon-clickable'
                                 href='/rss-all.xml'><span
                class='mdi mdi-rss-box blog-icon-rss'></span></a></div>
        </div>
        <div class='text-danger' id='js-fail-block'>
            <noscript>
                <small>JavaScript отключен в браузере, функционал сайта ограничен.</small>
            </noscript>
        </div>
    </div>
</div>
<script type='application/ld+json'>
    {
        "@context": "http://www.schema.org",
        "@type": "person",
        "name": "initkfs",
        "jobTitle": "",
        "url": "/index.html"
    }
</script>
            </div>
        </div>
    </div>
</footer>
<div class='mobile-up-wrapper text-center'>
    <button class='btn d-lg-none' id='mobile-page-up-trigger' type='button'><span
            class='mdi mdi-arrow-up'></span> Вверх
    </button>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" 
integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script crossorigin='anonymous' integrity='sha512-TPh2Oxlg1zp+kz3nFA0C5vVC6leG/6mm1z9+mA81MI5eaUVqasPLO8Cuk4gMF4gUfP5etR73rgU/8PNMsSesoQ=='
        src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js'></script>

<script crossorigin='anonymous' integrity='sha512-WW8/jxkELe2CAiE4LvQfwm1rajOS8PHasCCx+knHG0gBHt8EXxS6T6tJRTGuDQVnluuAvMxWF4j8SNFDKceLFg=='
        src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.min.js'></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.2/timeago.full.min.js" integrity="sha512-wb3lqal2VtYhmlPAr232VP+Zus676CFAEYdywxIUSxG6F/X9WhN6SpREkWUdwBvMpd6gCKuKTGHhdum6m1wOvQ==" crossorigin="anonymous"></script>

<script crossorigin='anonymous' integrity='sha512-9khQRAUBYEJDCDVP2yw3LRUQvjJ0Pjx0EShmaQjcHa6AXiOv6qHQu9lCAIR8O+/D8FtaCoJ2c0Tf9Xo7hYH01Q=='
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>

<script crossorigin='anonymous' integrity='sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw=='
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" ></script>

<script>
var problemScripts = [];
if (typeof jQuery === 'undefined') {
    problemScripts.push("jquery");
}

   if (typeof Prism === 'undefined'){
    problemScripts.push("prism.js");
   }
   
if (typeof Popper === 'undefined') {
    problemScripts.push("popper.js");
}

if (typeof timeago === 'undefined') {
    problemScripts.push("timeago.js");
}

if (typeof window.bootstrap === 'undefined') {
    problemScripts.push("bootstrap.js");
}

if (problemScripts.length > 0) {
    var message = "Ошибка загрузки JavaScript: " +
        problemScripts.join(",") +
        "." +
        " Возможные причины: блокировщик рекламы, проблемы с сетью, устаревший браузер. Может не работать дополнительный функционал.";

    var failInfoBlock = document.createElement("small");
    failInfoBlock.innerHTML = message;

    var mainFailBlock = document.getElementById("js-fail-block");
    if (!mainFailBlock) {
        console.error(message);
    } else {
        mainFailBlock.appendChild(failInfoBlock);
    }   
}
</script>
<script src="/assets/dev/js/main.js"></script>
</body>
</html>



