<!doctype html>
<html lang="ru">
<head>
    <meta charset='utf-8'>
    <meta name="yandex-verification" content="7021eeb9c07b5c09">
    <meta name="google-site-verification" content="PztbVe6Ru8ggM2n_tWUYwy0bEVHtJNvzIr-nsVCvBCA">
    
    
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <!-- favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/stab/img/favicons/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/stab/img/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/stab/img/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/assets/stab/img/favicons/safari-pinned-tab.svg" color="#004245">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/stab/img/favicons/apple-touch-icon.png">
    <meta name="msapplication-config" content="/assets/stab/img/favicons/browserconfig.xml">
    <!-- end favicons -->
    <!-- rss feeds -->
    <link rel=alternate title="RSS лента" type=application/rss+xml href='/rss-all.xml'>
    <!-- end rss feeds -->
    <link type="text/plain" rel="author" href="/humans.txt">
    <link crossorigin='anonymous' href='https://cdn.materialdesignicons.com/3.5.95/css/materialdesignicons.min.css'
          integrity='sha384-Ls5zBitvvQ/wdeZDuTUevSY5Tb/she50BeMPrco2ok6xDC8modj6/JPwdL0gNxmP' rel='stylesheet'>
    
    <link crossorigin='anonymous' integrity='sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ=='
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    
    <link href="/assets/dev/css/main.css" rel='stylesheet'>
    
    <title>Первое знакомство с ESP32. Космическая станция Аналитики - DIY техноблог о сложных IT-проектах</title>
    <meta name="description" content="Первое знакомство с ESP32 и анализ рисков проекта">
    <meta content='Первое знакомство с ESP32. Космическая станция Аналитики - DIY техноблог о сложных IT-проектах' property='og:title'>
    
    <meta name="keywords" content="esp32,electronics,risk analysis,hazop,eta">
    
    <meta content='/index.html' property='og:url'>
    <meta content='website' property='og:type'>
    <meta content='ru_RU' property='og:locale'>
</head>
<body>
<div class='container mb-3'>
    <div class='row'>
        <div class='col-lg-12'>
           <div class='card w-100 site-header-container'>
    <div class='row align-items-center'>
        <div class="col-lg-9">
            <div class='card-header site-header'>
                <div class='card-title site-header-title mb-3'>
                    <h5 class='site-header-title-text'>
                        <a href='/index.html' class='blog-title-text-link'>Космическая станция Аналитики - DIY техноблог о сложных IT-проектах</
                    </h5>
                </div>
                <div class='card-subtitle site-header-subtitle mb-2'>
                     <a href="/pages/about.html" class="badge mb-2 mb-sm-0">О станции и капитане</a>  <a href="/pages/site-implementation.html" class="badge">Сайт (Groovy-генератор)</a> 
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            
            <div class='site-map w-100 d-flex justify-content-center pe-lg-3'>
                <a class='site-map-link btn w-100' href='/site-map.html' role='button'><span
                        class='site-map-link-icon mdi mdi-sitemap'></span>
                    <span class='text-clarification'>Карта сайта (все статьи)</span></a>
            </div>
            
        </div>
    </div>
</div>
        </div>
    </div>
</div>
<div class='container'>
    <div class='row'>
        <div class='col-lg-9 blog-posts'>
            <article class='card post'>
    <h5 class='card-header post-header fw-bold'>
        Первое знакомство с ESP32
    </h5>
    <div class='card-body post-body'>
        <div class="card-title mb-3">
            <div class="post-body-header">

<div class='post-header-date'><span class='mdi mdi-calendar-clock'></span>
    <span class="post-datetime-text" data-iso-time="2023-01-09">9 января 2023</span>
</div>



<div class='post-labels'>
    <span class='post-header-labels-icon mdi mdi-tag-outline'></span>
    
    <a class='post-label-item badge font-weight-normal'
       href='/tags/elektronika.html' rel='tag'>Электроника
    </a>
    
</div>
</div>
        </div>
        <div class='post-content'><p>К электронике я был неравнодушен ещё со школьных лет, всегда тщательно разбирая нерабочую технику и часами выпаивая детали до полной очистки платы от них. К сожалению, из-за отсутствия у меня радиолюбительской литературы, эти электронные эксперименты нельзя было назвать успешными: работало сразу обычно самое простое, но совершенно бесполезное в быту, а что-то посложнее уже капризничало с последующей закономерной смертью проекта.</p>
<p>Появление в старших классах китайского аналогового, а позже и цифрового мультиметра можно было бы назвать огромным технологическим скачком. Но после долгой череды неудачных экспериментов, побоев током, взорвавшихся деталей от неправильного их использования, да и просто отсутствия доступа к нужным электронным компонентам, интерес к этой области постепенно угасал. Да и в жизнь плотно вошёл компьютер, который требовал всё больше и больше времени, блокируя любые другие направления.</p>
<p>Электроника же, в отличие от компьютера, завязывается на элементную базу, как и на множество самых разных инструментов, обойтись чем-то одним уже не выйдет. Детская любознательность, интерес к открытию нового с бессистемным изучением всего подряд заменился прагматизмом и тщательным планированием личного времени. Рост числа различных навыков рождает необходимость в распределении времени между ними, создавая классическую проблему масштабирования: затраты времени на новое сокращают время на старое. В таких жёстких условиях электроника также должна себя оправдывать и приносить пользу, а желательно много пользы. И здесь появляется проблема.</p>
<p>В качестве полезного результата можно получить уникальные электронные устройства, удешевление в части самих устройств или их ремонта. С другой стороны, что-то уникальное требуется редко, да и его часто можно заменить комбинацией ближайших аналогов. На рынке множество дешёвых устройств, которые за пределами гарантийных сроков ломаются примерно как и &quot;качественные&quot; брендовые. Починка во многих случаях себя не оправдывает из-за постоянного усложнения и повышения степени интеграции, стоимости модулей, снятия их с производства, общего снижения надёжности и характеристик из-за старения. Да и производитель обычно ремонту всячески препятствует и затрудняет его всеми силами.</p>
<p>Надёжность элементной базы - это тот ещё рандом, сложное устройство отказом подведёт в самый неподходящий момент. Оно требует много времени на наладку, тестирование и долгий путь к успеху, шансы которого обратно пропорциональны сложности. Много усилий будет уходить на поиск, выбор, покупку, изучение, тестирование деталей и модулей, что мало связано с предметными задачами проектов, тратя время впустую. Кроме того, у требовательных к питанию, более сложных устройств появляется один из самых высоких рисков - пожаро и электробезопасность. Отсюда практическая сторона электронных проектов меня интересует мало, но есть и другая сторона, более интересная и ценная.</p>
<p>Классическое софтостроение само по себе нестабильно, в нём огромное количество багов и проблем, но электронные устройства и embedded ещё нестабильнее и проблемнее: результат часто сложно переделать, цена ошибки выше, количество факторов, которые нужно учитывать при проектировании - больше, а любой грубый просчёт катастрофичен. Анализ и работа с такими проектами выглядит повышением уровня сложности, ибо теперь нужно не только программировать, но и собирать программируемое.</p>
<p>Отсюда мой интерес и цель - это, конечно же, эволюция и улучшение существующих айтишных навыков в т.ч. аналитических, как и архитектурных, да и всех остальных тоже, что делает потери времени оправданными.</p>
<p>В итоге интерес к электронике стал постепенно возрождаться, но, в сравнении со школьными годами, творческий интерес заменился прагматичным. Хотя, конечно же, какая-то творческая составляющая тоже должна быть из-за сильного влияния её на результат, а без результата любое изучение чего-либо не имеет особого смысла. Из-за недостатка времени я очень долго тянул с экспериментами, но такое затягивание бесконечным быть не может. И этот первый пост в 2023 году знаменует старт более серьёзных практических экспериментов для обучения и закрепления теории на практике. Но с этими экспериментами есть одна проблема.</p>
<p>Сама по себе электроника, как любая область знаний - очень и очень объёмна, что вступает в конфликт с небольшим ресурсом времени на неё и вспомогательной обучающей ролью выше. С уменьшением степени абстракции над железом техника специализируется, как и повышаются затраты времени на получение результата. Для поддержания знаний нужна постоянная практика, которая для DIY-устройств носит периодический и ограниченный характер. Аналоговая схемотехника и примитивная цифровая требуют также более точного, более сложного, а местами очень специализированного оборудования и софта, без которого можно вполне обойтись.</p>
<p>Кроме того, в самодельничестве невыгодны специализированные устройства. Классическая философия UNIX требует однозадачности программ, да и многие известные архитектурные паттерны пересекаются с разделением ответственности (High Cohesion в GRASP, Single responsibility в SOLID и т.д). Но на практике возникнет проблема сопровождения большого зоопарка устройств.</p>
<p>Синхронизация кодовых баз, обновления, улучшения, фикс регрессионных багов из-за изменений, тестирование и прочее обслуживание в одиночной разработке затруднено, а потери времени на всё это должны быть максимально сокращены. Хотя именно для электроники здесь появляются плюсы, например, устройства могут служить друг другу донорами запчастей, но это не компенсирует всех проблем.</p>
<p>Другая проблема в ограничениях функционала, для роста которого необходим рост абстракций с упрощением и ускорением разработки. Здесь ровно такая же проблема, как я описывал в самом начале: простое в быту бесполезно, оно либо может быть заменено существующими аналогами в т.ч. их комбинацией, либо вообще не нужно в силу своего упрощения, а любые потери времени на него себя не оправдывают.</p>
<p>Тесно связаны с этой проблемой и ошибки в функциональных и нефункциональных требованиях, когда результат выглядит полезным, но при дальнейшей работе вскрывается его неудобство, бесполезность, да и вообще мёртворожденный концепт. И это разочарование усилится потерянным временем. На ранних этапах жизненного цикла обычно всегда есть ошибки и промахи по требованиям, что требует постоянных переделок, а они могут быть очень проблематичны.</p>
<p>Учитывая все эти и многие другие проблемы, есть смысл ограничить эксперименты определённым уровнем абстракции устройств от железа, ибо промышленные цели и самодельнические очень сильно расходятся, а используемые инструменты и платы не могут быть одинаковыми.</p>
<p>Для этой цели можно разделить условные модули, платы, устройства на несколько групп по разнообразию решаемых задач обработке данных. Какая-то подходящая классификация мне пока не попадалась, так что может выйти что-нибудь наивное:</p>
<ul>
<li>Персональные компьютеры: стационарные и мобильные, планшеты, мобайл с GPIO через USB-TTL или сеть.</li>
<li>Одноплатники (SBC): Raspberry Pi, Orange Pi, Banana Pi и похожие.</li>
<li>Отладочные платы и платформы для сети IoT.</li>
</ul>
<p>С другой стороны, круг решаемых задач также сокращается. Например, wearable electronics (носимая электроника) имеет очень жёсткие ограничения, что намекает на очень специализированные платы и модули, с большой долей ручного управления железом.</p>
<p>С другой стороны, техника постоянно усложняется, бурный рост IoT в ближайшие годы потребует и более быстрой, упрощённой и безопасной разработки. Это рождает шанс попасть в период смены технологического стека, что обнулит все предыдущие навыки, большая часть которых станет бесполезной. Аналогии и опыт из-за сильного различия между стеками перенести будет почти невозможно, как и невозможно будет догнать по знаниям и квалификации тех, кто не имел потерь времени на легаси. Это один из самых известных айтишных рисков, что также влияет на мой выбор целей для экспериментов, как и уровней их абстракции.</p>
<p>В случае отказа какого-либо устройства более низкого уровня, его функцию может взять на себя предыдущий. Так, если в системе умного дома отказывает модуль маршрутизации информации от датчиков, то через GPIO или сеть их можно быстро подключить к одноплатникам или десктопу в обход неработающего узла, имея много маневров для повышения надежности, отказоустойчивости, да и прочих нефункциональных требований.</p>
<p>Продвинутое железо позволяет использовать самые разные языки в т.ч. прикладные, что сильно ускоряет, облегчает разработку и сопровождение кода, сокращая потери времени, как и пересекается с самыми разными айтишными навыками, способствуя их прокачке. Хотя его достаточно обидно сжечь по неопытности, в зависимости от устройства могут быть проблемы с питанием и автономной работой, теплоотводом, ограничениями GPIO и т.п. Но это не самая большая проблема.</p>
<p>Если эти устройства хорошо работают в роли обработки данных, то использование их для каких-то специализированных односложных задач, например, проброса информации от датчиков выглядит очень проблемным, что усложняет построение сети IoT.</p>
<p>Можно, конечно, обмазаться одноплатниками, но масштабироваться это всё будет намного хуже чем более примитивные платформы, а в зависимости от задач и вообще не будет. Правило &quot;каждой задаче - свой инструмент&quot; никто не отменял. А ещё с повышением уровней абстракции может уменьшаться обучающая полезность проектов, ибо соединение между собой полностью готовых и настроенных модулей может вообще не требовать ни знаний в электронике, ни программирования как такового.</p>
<p>Отсюда очень сложно обойтись только лишь персональным компьютером или одноплатниками. С другой стороны, в этом наивном списке явно виден слишком большой скачок от одноплатников к отладочным платам, подразумевающий какой-то класс устройств между ними, но подходящего кандидата я пока не встречал.</p>
<p>На рынке также есть много продвинутой техники, допускающей программирование, но чем устройство сложнее и функциональнее, тем больше оно требует времени на изучение нюансов. Эти навыки получаются специализированными и запросто могут обнуляться при смене бренда или типа устройств на другие. Из-за этих рисков я пока не выделял их в отдельный интересующий меня класс, хотя что-то вполне можно использовать, конечно же. Например, если устройство завязывается на свободный код, какой-то активно поддерживаемый сообществом репозиторий или библиотеку, то рисков становится меньше.</p>
<p>Получается, что начинать электронные эксперименты выгоднее с десктопа, мобайла и одноплатников, поскольку они наиболее близки к классическому IT, универсальны и экономят время. Однако тут появляется высокий риск уничтожения устройства по неопытности, что намекает на обучение наоборот - с низких уровней и выше, где платы дешевле, как и неудачные эксперименты с ними. Учитывая потребность в большом количестве примеров и туториалов, первый претендент здесь - это инфраструктура ESP8266 и ESP32.</p>
<p>Мой айтишный стереотип и отношение к легаси заставили всё-таки остановиться на ESP32, как продолжение линейки ESP8266, предполагая, что производитель понизит свой интерес и приоритет времени на поддержку хотя и огромного количества, но с каждым годом стареющих морально плат. Хотя эти предположения, конечно же, ничем не обоснованы.</p>
<p>Плат на ESP32 очень много всяких разных, но тут нужна высокая доля сходства с обучающими материалами. Пробные запросы в гугл выявили завязку части туториалов на ESP32 WROOM DevKit.</p>
<p>На всякий случай предварительно поинтересовался проблемами с драйвером CH340 на моей версии линуксового ядра и они обнаружились, поэтому искал плату именно с CP2102.</p>
<p>Нельзя сказать, что плата модная, молодёжная, но зато популярная, а популярность должна уменьшать сложность решения проблем (теоретически). Относительно высокое потребление, бесполезность для меня Bluetooth, небольшое количество пинов не самая большая проблема, есть кое-что более трагичное.</p>
<p>Наибольшая проблема для меня здесь - это С\С++ тулчейн, тратить время на который мне невыгодно от слова совсем, ибо я использую другой системный стек, полностью покрывающий все мои задачи. При трате времени на любой другой язык в силу альтернативных издержек уменьшится время на уже используемые, что нанесёт им большой вред. Можно <a href="https://www.phoronix.com/forums/forum/phoronix/latest-phoronix-articles/1365817-llvm-lands-new-backend-for-xtensa-architecture">немного подождать</a> их архитектуру в основной ветке LLVM, но на данный момент есть следующие варианты:</p>
<ol>
<li>Смириться. IoT платформа имеет множество ограничений и по мере усложнения логики будет всё больше проблем. А что-то простое можно писать дубово-процедурно и не выходить за рамки того же С. Уменьшение функционала и упрощение сократит и затраты времени (опять-таки, теоретически).</li>
<li>Собрать LDC под Xtensa через их <a href="https://github.com/espressif/llvm-project">форк LLVM</a>, получив там D. Вернее, betterC с биндами на их sdk, что не радует какими-то значительными преимуществами, оправдывающими усложнение обновления и сопровождения, интеграцию с C++ и т.п. сложности для самых первых экспериментов.</li>
<li>Сделать то же самое с более современными языками ради их обучающего потенциала, например, с Zig, но выглядит это примерно как и п.2. с бонусом проблем портирования кода с си и плюсов из-за сильного различия в синтаксисе. Да и нестабильность самого компилятора потребует миллионов пересборок.</li>
<li>Взять что-то вроде линейки ESP32-C3, что на RISC-V. Но на данном этапе для меня ценны туториалы и примеры, использовать которые скорее всего станет значительно тяжелее. Судя по материалам в сети это версия позиционируется как замена ESP8266 и порезана по функционалу. А <a href="https://www.espressif.com/en/news/ESP32-P4">ESP32-P4</a> родился буквально на днях.</li>
</ol>
<p>Что касается NodeMCU, то изначально я рассматривал его, как и Espruino. Но если для обычного программирования повышение уровня абстракции упрощает кодинг, то здесь может сработать наоборот: лишние слои вносят побочные эффекты и проблемы, бороться с которыми на голом железе намного тяжелее. JTAG отладчиком я ещё не обзавёлся, ибо в процессе экспериментов мои интересы к железу могут запросто поменяться.</p>
<p>После серии экспериментов с IDE я остановился на <a href="https://platformio.org">PlatformIO</a>. Здесь рождаются муки выбора: ограничиться нативным ESP-IDF, либо же его версией с Arduino. С одной стороны, ардуиновские библиотеки вносят побочные эффекты и скрывают часть реализации, с другой - скетч обладает более высокой кроссплатформенностью между разными платами, да и должен облегчать (теоретически) адаптацию кода из туториалов. Да и саму FreeRTOS я пока недостаточно понимаю и знаю. Поскольку апи esp-idf можно свободно дёргать и так, то ардуиновский вариант пока победил. Инструменты для экспериментов выбраны, остаётся подумать над проектом.</p>
<p>При поиске идеи сразу вспоминается пословица: любой проект на Arduino рано или поздно становится метеостанцией, что наверное частично применимо и к ESP. Метеостанция - это классический и очень интересный DIY-проект из-за связи с разными естественными науками, но пока я к нему не готов.</p>
<p>Альтернативным вариантом выглядит другой популярный класс проектов - охранные сигнализации, тесно связанные с анализом рисков, что хорошо укладывается в формат исследовательской статьи и блога. Конечно, результат такого обучающе-тренировочного проекта будет совершенно бесполезным, но таковы законы любого обучения, ибо для выхода в сложные проекты нужны время и практика.</p>
<p>Большая часть достоинств и проблем проекта упирается в его сердце - ESP. Концептуально, из-за встроенной беспроводной сети, такой проект выглядит как мобильный модуль, оповещающий о нарушении защищаемого периметра как самостоятельно, так и транслирующий информацию с датчиков куда-то ещё. Из-за ограничений железа, сложности тестирования и отладки, какую-либо сложную логику выстроить тут проблематично, архитектура должна быть максимально простой и дубовой.</p>
<p>Бегло пробежимся по требованиям. Наверное главное функциональное требование, сложное для плат этого класса - не тупить. Сигнализация требует исключения ложных срабатываний, как не срабатывания в нужный момент, последствия могут быть катастрофическими.</p>
<p>Но надёжность самой платы очень трудно предсказать, а в сети огромное количество случаев умирания плат по неизвестным причинам. Следовательно, рождается другое требование: своевременное определение отказа, что намекает на &quot;маяк&quot; - периодический импульс активности. Однако в случае сигнализации злоумышленник может подделать маяк и эмитировать нормальную работу устройства в т.ч. взломав домашнюю сеть.</p>
<p>Отсюда неплохо бы добавить видеонаблюдение, которое тоже можно подделать, но немного сложнее. Оно же используется в различных сигнализациях и для исключения ложного срабатывания, когда система записывает короткий ролик, который просматривает оператор и делает заключение о вызове спецслужб.</p>
<p>Из доступных нагуглились модули камер OV7670, 7675 и похожие. Подключение нелёгкое, через SPI с проводной лапшой, успехи по отзывам противоречивые, но потенциально оно может работать. Но я не уверен, что такое железо вытянет эту камеру для передачи более-менее качественных изображений через сеть, а вот риски сжечь плату повышаются. Поэтому для целей эксперимента я обойдусь без изображений и видео, хотя это и сильно ударяет по требованиям.</p>
<p>Для этой цели лучше выглядит ESP32 CAM и аналоги, конечно же. Ну или какая-то промышленная Wi-Fi камера. Проблемы слепоты устройства снижаются при работе сигнализации в сети IoT, тогда какой-то другой модуль с камерой отвечает за видеонаблюдение. Всё это подтверждает список устройств выше: IoT-платформы хорошо работают как однозадачные модули.</p>
<p>С другой стороны, отсутствие видео хотя и создаёт риск, но все ещё позволяет охранять периметр, но модуль может быть как внутри охраняемой зоны, так и вне её. Последний вариант требует охраны и самого модуля, что намекает на расположение одного или нескольких датчиков как можно ближе к корпусу устройства, а желательно рядом с ним, охраняя и его тоже. Это повышает мобильность модуля, его можно взять куда-то с собой, а потом легко подключить обратно.</p>
<p>Однако сам модуль может располагаться в разных местах, что требует охраны больших площадей и намекает на дистанционные датчики движения. Из простых был найден пироэлектрический инфракрасный датчик HC-SR501. Его можно переделать под 3.3В, но это создаёт проблемы в будущей быстрой замене, как и возможном дублировании датчика ещё одним, который тоже нужно будет перепаивать. Выглядит так себе перспектива, проще обойтись без переделок. С другой стороны, появляется шанс что-нибудь перепутать, запустив 5В на пины ESP, что приведёт его к смерти.</p>
<p>После паруминутной калибровки при обнаружении движения датчик формирует на выходе импульс высокого уровня, настраиваемый по времени. Этот импульс можно направить не на ESP, а куда-нибудь ещё в т.ч. изолировав датчик для его тестирования.</p>
<p>Датчик вполне самодостаточен для простых устройств, а учитывая наличие стабилизатора и универсален. Кроме того, на нём даже есть места для апдейтов в виде фоторезистора для работы в темноте, как и терморезистора для исключения ложных срабатываний от скачков температур.</p>
<p>В случае поломки платы с ESP, датчик всё ещё позволяет использовать модуль с другой системой оповещения, такое переключение неплохо бы сделать максимально удобным и быстрым. С другой стороны, это увеличит количество лапши из проводов, а учитывая дальнейшее масштабирование и увеличение числа датчиков, выглядит бесполезным т.к. изоляция каждого отдельного датчика осложнится, как и замена их на другой с иной логикой работы.</p>
<p>Сам по себе пьезоэлектрический датчик склонен к ложным срабатываниям, как и плох в роли датчика присутствия, не замечая очень медленные движения или неподвижного человека. Теоретически, его наверное можно обойти специальным экраном, устройством и т.п. хаками, так что без дополнения чем-то другим он выглядит рискованно. Ещё в сети пишут, что ресурс его подстроечников (как вариант, сам процесс изменения настроек) очень ограничен, но тут не проверял.</p>
<p>Основным недостатком выглядит сложность мониторинга его работоспособности. Отвал контакта данных изменит уровень входа у ESP с подтягивающими резисторами, а вот отсутствие питания или срабатывания проверять уже сложнее. Ну и сам по себе такой датчик система относительно сложная и не всегда нужная.</p>
<p>Подстраховкой ему нужен дубовый вариант - несколько герконов. По сценарию наихудшего случая злоумышленник знает их расположение, может проникнуть в охраняемую зону каким-то нетривиальным путём, так что полезность герконовой защиты не так высока. Но они позволяют контролировать отдельные части помещения, что может быть необходимым по тем или иным причинам. Кроме того, геркон легко поменять на кнопку, какие-то контакты, что универсально и удобно.</p>
<p>Что касается модуля аутентификации, то его мне проще исключить. В промышленных сигнализациях он необходим из-за большого количества пользователей и ролей, в подобном модуле его отсутствие, во-первых, сильно упростит систему, а во-вторых, позволит лучше её тестировать, а именно - срабатывание датчиков именно в режиме охраны.</p>
<p>Любой режим создаёт множество условий и веток if-ов, тестирование работоспособности в одном режиме может совершенно не влиять на другой. Если тестировать датчики до установки на охрану, то нет гарантии, что они сработают при нарушении периметра. Постоянное тестирование именно режима охраны выглядит более надёжным для этого случая. Исключением может быть наличие старого доброго оповещателя &quot;ревун&quot;, постоянное срабатывание которого при снятии с охраны идея сомнительная. С другой стороны, он может включаться с задержкой, достаточной для отключения тревоги или что-то около того.</p>
<p>Кроме того, любые пользовательские действия нужно ограничивать и логировать. Здесь можно вспомнить недавний <a href="https://www.securitylab.ru/news/534761.php">случай с умными дверями Aiphone GT</a>, которые не имели ограничений попыток ввода кода доступа и не логировали действия, позволяя злоумышленнику не оставлять никаких следов своего присутствия.</p>
<p>В случае его наличия я бы попробовал RFID, как один из самых простых вариантов. iButton с 1Wire торчащим наружу контактом так или иначе даёт доступ к железу. Можно поставить супрессор, например, от статического электричества, какого-то вменяемого порога напряжения, но каким этот порог должен быть, ведь этот контакт находится в руках злоумышленника и там условно может быть любое напряжение. Да и под вопросом влияние на мобильность: в случае использования модуля в неудобных условиях, приспособить куда-то этот контакт сложнее. А если что-то где-то торчит открыто на виду, то его обычно ковыряют, поджигают или ломают изощрёнными способами, защиты от которых не существует.</p>
<p>Другой вариант: управление модулем через сеть. Без собственных велосипедов можно ограничиться, например, мессенджерами с ботом. Задача взлома такой системы уже сводится к взлому сторонних и неплохо защищённых сервисов, что потребует знатных усилий, хотя сама плата, роутер, смартфон и прочие участники этой схемы всё также подвержены взлому.</p>
<p>Основная проблема здесь даже не в защищённости и надёжности сети, а в способе получения управляющих сигналов, что предполагает постоянное соединение с сетью, либо постоянные проверки. Если микроконтроллер находится в режиме энергосбережения, то его нужно разбудить, но для получения сигналов нужна сеть, которая выключена. Для мобильного модуля постоянная работа сети или контроллера сильно понизит универсальность и время жизни от автономного  питания. Даже если модуль работает стационарно, то сеть банально может не требоваться в работе, а оповещение происходить сигналами с пинов, включающими какие-то другие устройства. В этом случае бесполезная сеть повышает риск удалённого взлома платы, ибо это всё-таки двери внутрь устройства и домашнюю сеть, да и впустую тратит драгоценные ресурсы микроконтроллера.</p>
<p>Эта проблема сразу вскрывает ключевые архитектурные грабли: последующее добавление режимов энергосбережения. Если изначально устройство было спроектировано только на постоянную активность контроллера, то добавление этого требования приведёт к масштабному рефакторингу и тестированию с нуля. Есть смысл закладывать сон сразу. Даже если эта логика не потребуется, то её полноценный реюз осложнится в системах с энергосбережением, а они распространены.</p>
<p>Поскольку речь зашла об автономии, то нужно упомянуть и о питании. Мобильность проекта предполагает автономное питание, как и своевременное переключение с одного вида питания на другой. Однако потребление у ESP32 достаточно высокое, а мощные аккумуляторы повышают риск пожара, предсказать отказ в платах BMS тоже сложно. Если ставить что-то дублирующее, контролирующее, то законы Мерфи не исключают отказа и там, и там одновременно. Поэтому я пока не определился с автономным источником, а проблемы с питанием и жизнью платы можно условно определить по отсутствующему маяку.</p>
<p>На борту плата имеет стабилизатор AMS1117-3.3 с заявленным током в 0.8А. Самый простой путь - это купить блок или модуль питания, но для обучающего проекта это не принесёт никакой пользы. Импульсный БП собирать тоже сложно, как и анализировать, пришлось поискать что-нибудь среди старого хлама.</p>
<p>В закромах откопался трансформатор от старого аудиомагнитофона на 10В. Поскольку стабилизатор линейный, а плата хочет минимальных 5В, то имеем для максимального тока грубо (10В - 5В)*0.8 = 4Вт рассеиваемой мощности, что в корпусе SOT-223 выглядит нереалистичным. Термическое сопротивление в даташите варьируется от 46° до 90°C/Вт, но маленькая пластиночка на плате выглядит не очень серьёзно. Так что есть смысл на всякий случай взять предельное в 90°, тогда для температуры стабилизатора около 100° (максимальная в 125 выглядит немного высоковатой) при комнатной температуре в 25° мощность не должна превышать: (100 - 25) / 90 = 0.8Вт, причём учитывая очень тёплое лето последние годы, накопление тепла в корпусе модуля и нагрев других элементов в нём это ограничение должно быть ещё более жёстким, да и запас должен быть. На максимальное потребление модуль может выйти банально из-за программной ошибки или по загадочным причинам в т.ч. игнорируя энергосберегающие режимы.</p>
<p>Отсюда питание через пин Vin таким трансформатором выглядит плохой идеей. Один из самых простых способов - использовать линейный стабилизатор, хотя из-за низкого КПД много энергии будет уходить в тепло. Но его отказы анализировать значительно проще, в отличие от импульсных БП, да и в хозяйстве завалялась LM7805. Сам по себе ESP может запросто стать горячей печкой, так что помещать два таких источника тепла в один корпус не хотелось бы, но опять-таки, линейный БП проще. Запас по току здесь получается <strong>очень небольшим</strong>, учитывая будущее масштабирование и потребности датчиков в отдельном питании, так что более мощные стабилизаторы выглядят тут получше.</p>
<p>При тестировании платы она начала циклично перезагружаться при попытке включения WiFi. Если всё работает с USB и не работает с кастомным БП, то вывод прост: виноват БП. Благодаря простоте конструкции подозрение сразу пало на входной фильтрующий конденсатор и замена его на более высокую ёмкость устранило проблему перезагрузок.</p>
<p>Рассмотрим разные варианты плохих событий, могущих произойти с проектом. Полноценный анализ рисков трудоёмок и очень объёмен, поэтому я буду уделять больше внимания электронной части, акцентируясь лишь на условно значимом.</p>
<p>Основная проблема такого анализа - это сложность вскрытия причинно-следственных связей из-за отсутствия электронного опыта, что сведёт большую часть предположений к наивному угадыванию. В таких условиях наиболее полезные аналитические инструменты вроде того же <a href="https://ru.wikipedia.org/wiki/FMEA">FMEA</a> использовать затруднительно. Поэтому есть смысл начать с <a href="https://ru.wikipedia.org/wiki/HAZOP">HAZOP</a>, который своими управляющими словами подталкивает к выявлению рисков, позволяя какую-то часть из них выявить без достаточного опыта в предметной области.</p>
<p>Этот анализ хорошо визуализируется таблицами, но с ними есть как проблемы на мобайле, так и неудобство редактирования из Markdown, табличный формат которого достаточно упоротый. Поэтому я буду описывать всё текстом. В общем случае таблица содержала бы столбцы: ключевое слово, отклонения, причины, последствия, действия или что-то в этом роде. Но в текстовом формате её можно упростить, да и часть предположений о причинах и последствиях могут быть либо наивными, либо бесполезными сами по себе. Для воспроизведения отказов самый лучший способ - это реальное тестирование, что требует инструментов и определённых жертв в компонентах, которые будут умирать в процессе. Рассмотрим разные части охранного модуля.</p>
<p><strong>В структуре блока питания (БП) имеем:</strong></p>
<p>Трансформатор - два плавких предохранителя на первичной и вторичной обмотках, диодный мост с конденсатором.</p>
<p>LM7805 с обвязкой - несколько конденсаторов, диодный шунт для защиты от обратного напряжения, как отмечено в даташите, светодиод с резистором для индикации питания.</p>
<p><strong>НЕТ</strong></p>
<p>Нет напряжения в электрической сети из-за аварии в сетях электроснабжения. Тут необходим автономный источник питания. Как отмечал выше, пока с аккумуляторным питанием я не определился из-за его пожаро и взрывоопасности.</p>
<p>Нет контакта вилки трансформатора с розеткой из-за расшатывания или поломки. Здесь уместна периодическая проверка контакта.</p>
<p><strong>БОЛЬШЕ, МЕНЬШЕ</strong></p>
<p>Повышенное или пониженное напряжение в сети из-за аварий, перегрузки в вечернее время, мощных электроприборов и т.п. Необходимо подключение в устройство защиты от перепадов напряжения или защита, например, варисторная.</p>
<p>Сюда же наверное есть смысл отнести и электромагнитные всплески, например, из-за молний, особенно в грозовой летний период. Учитывая модульность блока, он вполне может использоваться где-то на выезде, а сухая гроза наверняка может сделать отказ очень внезапным, а возможно ESP и выдержит. Но пока я не встречал в литературе простого способа защиты, как и упоминаний о поведении платы, ну разве что <a href="https://esp8266.ru/forum/threads/esp32-perexodit-na-ponizhennuju.5066/">вот похожее</a>, но это не точно.</p>
<p>Сюда же, возможно, стоит отнести и магнитострикцию трансформатора с гудением и повышением вибрации пластин. Но это достаточно легко обнаруживается по звуку.</p>
<p><strong>ДРУГОЙ</strong></p>
<p>Нарушения формы синусоиды, всяческие отклонения частоты, амплитуды. Защита та же, что и от проблем сети.</p>
<p><strong>ТАКЖЕ</strong></p>
<p>Помехи, гармоники в сетях. Можно вспомнить случай с недостаточной ёмкостью фильтрующего конденсатора. Теоретически, поскольку уровень пульсаций или шума, необходимый для цикличной перезагрузки платы неизвестен, то нельзя исключать, что включение какого-либо прибора в домашней сети легко может создать эту проблему, а ёмкость конденсатора снова окажется недостаточной. Так что дополнительный сетевой фильтр здесь выглядит очень нужной подстраховкой.</p>
<p>Ещё, как вариант, проблема может быть в неспособности электролитического конденсатора хорошо бороться с высокочастотными помехами, что требует параллельного включения какого-нибудь керамического помощника.</p>
<p><strong>ЧАСТЬ</strong></p>
<p>Замыкание первичной или вторичной обмотки трансформатора, возможен пожар.<br/>Должны сработать предохранители, как в устройстве, так и в щитке. Однако время срабатывания может запаздывать, поэтому риск пожара всё-таки сохраняется. Да и если трансформаторный блок будет располагаться в корпусе, то на срабатывание плавкого предохранителя может влиять температура в корпусе, которая тут малопредсказуема из-за двух &quot;печек&quot; - ESP и 7805. Есть смысл изолировать устройство в металлический корпус, однако перекрытие доступа воздуха будет вызывать проблемы с охлаждением. Даже если бы там не было линейного стабилизатора, то мог начать греться ESP по необъяснимым причинам, так что вентиляция должна быть.</p>
<p>Более сложные вариант - регулируемая вентиляция, тогда можно перекрыть доступ воздуха, как один из факторов жизни огня, но реализовать это сложнее.</p>
<p>Также здесь неплохо было бы поставить какой-нибудь датчик огня. Как вариант, тот же популярный ардуиновский на компараторе LM393, но, возможно, есть что-нибудь и получше. Вопрос в том, успеет ли датчик выдать сигнал, а ESP его отправить до того, как огнём будет повреждены провода и модули устройства, но всё-таки какой-то шанс успеть есть.</p>
<p>Особая проблема будет в случае глубокого сна, что потратит драгоценное время на выход из сна и подключение к домашней сети. В случае наличия автономного питания и повреждении огнём одного из источников, может произойти успешное переключение на другой и плата успеет сообщить о беде. В случае же с питанием только от сети шанс здесь выглядит не очень большим, но наверное он всё-таки есть.</p>
<p>Ещё такие датчики могут не реагировать на пламя с отличающейся длиной волны: он хорошо срабатывает на пламя спички или свечи, но может игнорировать пламя, например, горящего газа синего цвета. Поскольку в корпусе много проводов с изоляции, всякой пластмассы, которая может окрасить пламя, то есть некий шанс не срабатывания в начальной стадии. Хотя по мере распространения пламени он так или иначе сработает, но может быть уже поздно, ибо основное требование - это срабатывание как можно раньше.</p>
<p><strong>ЗАМЕНА</strong></p>
<p>Изменение полярности на выходе трансформатора, например, после какого-нибудь ремонта или же неправильного подключения разъёма. Есть смысл установить защитный диод, пытаясь подстраховаться одновременно и от появления переменного тока из трансформатора.</p>
<p>Поскольку диоды могут как пробиваться, так и замыкаться накоротко (промежуточное состояние - повышенное внутреннее сопротивление), то второй случай есть смысл рассмотреть отдельно, например, под ключевым словом ДРУГОЙ.</p>
<p><strong>ДРУГОЙ</strong></p>
<p>На выходе трансформаторного блока появится переменное напряжение через замкнутые диоды. Но защитный диод от изменения полярности должен превратиться в однополупериодный выпрямитель. Сам по себе он содержал бы большое количество пульсаций, но поскольку следом идёт фильтрующий конденсатор, то это напоминает пиковый детектор и диод должен блокировать ток из конденсатора обратно в трансформатор. Его пульсаций, вероятно, всё равно может быть очень много и плата начнёт также перезагружаться как и при проблемах с конденсатором на входе.</p>
<p>Ещё проблема, что если оно всё-таки заработает, то такой отказ достаточно сложно обнаружить. Возможно, есть какой-то способ контроля питания, навроде комплексных датчиков напряжения, тока и мощности навроде INA219 и т.п., но это выглядит недостаточным, что-то вроде катушки Роговского слишком экзотическим. Так что это вопрос пока остаётся открытым.</p>
<p><strong>Следующее звено - LM7805 с обвязкой.</strong></p>
<p><strong>НЕ ИЛИ НЕТ</strong></p>
<p>Отсоединение или плохой контакт с дорожкой платы, как и отказ самой микросхемы. Индикаторный диод должен погаснуть.</p>
<p>Отсоединение или плохой контакт с радиатором, что приведёт к перегреву и срабатыванию защиты (ну, или к смерти стабилизатора). Здесь уместна периодическая проверка креплений.</p>
<p><strong>БОЛЬШЕ</strong></p>
<p>На выходе перенапряжение. С одной стороны, это достаточно опасно, с другой - далее на плате будет стабилизатор, который поимеет проблем с рассеиваемой мощностью, но хотя бы немного должен поработать. Если бы плата контролировала питание датчиком, то возможно отключить какие-то функции либо перейти в энергосберегающий режим в этот момент. Вопрос остаётся в уровне высокого напряжения, который запросто может выйти за верхний предел стабилизатора на ESP-плате. Если был бы импульсный БП, то появление очень высоких напряжений на его выходе было бы наверное более вероятным, намекая всё-таки на дополнительную защиту.</p>
<p>Повышение температуры. Здесь должна сработать защита стабилизатора, но она может по каким-то причинам и не сработать. Особенно пострадают от неё электролиты, так что конденсаторы есть смысл брать на высокие температуры и размещать подальше он горячих точек. Учитывая всё более тёплые летние деньки с разогревом до 35°, возможный источник тепла со стороны ESP, то температуру в корпусе устройства есть смысл всё-таки контролировать.</p>
<p>С продвинутыми датчиками для IoT я ещё не знакомился, но зато в закромах был найден любопытный экземпляр - советский терморезистор ММТ-4 на 100К (в сети пишут, что это при 20°C). Пришлось немного погуглить и перебрать разные варианты уравнения Стейнхарта - Харта для работы термистора в резистивном делителе, пока он более-менее стал показывать правду. Не тестировал на всём диапазоне температур, но показания сходятся с комнатным термометром. Обнаружилось, что ADC2 отказывается <a href="https://github.com/espressif/arduino-esp32/issues/440">работать при включённом WiFi</a>. Ещё в сети ругают АЦП у ESP32, так что искажения вполне могут быть.</p>
<p>Технически, учитывая мобильность модуля температура может быть и пониженной, что может привести к резкому падению ёмкости и росту ESR электролитов, как и отказами в других компонентах.</p>
<p><strong>МЕНЬШЕ</strong></p>
<p>На выходе низкое напряжение. Что может быть, например, из-за нормального падения напряжения у защитного Шоттки на выходе, что может отразиться на ESP, но пока вроде как ему достаточно.</p>
<p><strong>ЧАСТЬ</strong></p>
<p>Плохая стабилизация, например, из-за отсоединении конденсаторов в обвязке. Пишут, что в этом случае микросхема может греться и замыкаться. Эту неисправность может быть сложно обнаружить без контроля за питанием.</p>
<p><strong>ЗАМЕНА</strong></p>
<p>Изменение выходной полярности из-за ремонта или неправильного подключения. Изначально я поставил Шоттки именно для этой цели, но он сработал и для следующей</p>
<p><strong>ДРУГОЙ</strong></p>
<p>Обратное напряжение. Когда я ставил диод для защиты от смены полярности, то ещё не знал, что при питании ESP от USB на его Vin внезапно появляется 5В, которые, конечно же, попадут без диода на БП и на выход LM7805. В даташите микросхемы рекомендовано поставить обратный диод между входом и выходом, так что должен сработать он, а ёмкость выходного конденсатора намного меньше чем на входе. Но, как вариант, контакт диода может отвалиться, что тоже очень сложно обнаружить и надеяться на него тоже такое себе.</p>
<p>Обратное напряжение может быть и другой полярности. На выходе стоит электролитический конденсатор, на которые попадёт 5В обратной полярности. Будет ли достаточно это для выхода из строя или взрыва, даже учитывая большой запас по напряжению, тоже вопрос. Ну и даже без взрыва, теоретически, оно может как-то сократить срок службы самого конденсатора, создавая отложенный во времени отказ.</p>
<p>В БП из деталей остаются обвязочные конденсаторы, да индикаторный диод.</p>
<p>Для конденсаторов может случиться: падение ёмкости, повышение напряжения, повышение температуры, потеря контакта с дорожкой, замыкание или обрыв. Часть проблем сложно обнаружить. Можно подстраховаться запасом на напряжению и температуре, ну и держать конденсаторы подальше от горячих мест.</p>
<p>Есть смысл рассмотреть переходные процессы при зарядке конденсатора большой ёмкости на входе. В начальный момент он должен вести себя как перемычка, что повлияет на предохранитель в трансформаторе, создавая шанс его перегорания, как и закоротит диоды на входе. Но предохранитель там заводской и явно взят с некоторым запасом, а ток, вероятно, ограничивает сам трансформатор. Так что вроде как работает. Если поставить балластный резистор небольшого значения, то у него должна быть очень большая мощность рассеивания, возможно, тут нужен PTC термистор, который, разогреваясь, будет увеличивать сопротивление.</p>
<p>Технически, тоже самое может произойти и с выходным конденсатором, тогда сработает (должна сработать) защита микросхемы от перегрузки, но ёмкость там не очень большая.</p>
<p><strong>Индикаторный светодиод</strong></p>
<p>Как любой резистор, ограничивающий резистор светодиода может быть источником шума, обрываться и закорачиваться, но эти проблемы выглядят не слишком критичными. С другой стороны, здесь может проявляться взаимосвязь событий, что обычно сильно усложняет любой анализ. Закороченный резистор ведёт к перегоранию светодиода, который, в отличие от ламп накаливания, перегорая, тоже закорачивается. Тогда должна сработать защита БП от перегрузки. Единственное, что из-за потенциальных источников тепла резистор логичнее выбирать с более низким ТКС, иначе при разогреве всей конструкции будет сильно прыгать его сопротивление, что в сочетании с дешёвым светодиодом наверное может привести к случайным отказам, как вариант.</p>
<p><strong>НЕ</strong></p>
<p>Обрыв и отсутствие питания на светодиоде. Тогда 7805 может работать вообще без нагрузки, но судя по примерам и отзывам в сети она может. Некоторые DC-DC преобразователи могут начать разогреваться в этом случае, но тут не тестировал.</p>
<p>Что касается его закорачивания, то БП начнёт работать на резистор светодиода, его мощности рассеивания вполне достаточно. Здесь, вероятно, могли бы быть взаимосвязанные события. Как вариант, если бы светодиод потреблял ток побольше, то резистор мог бы быть низкоомным. После закорачивания светодиода на этом малом сопротивлении начнёт рассеиваться большая мощность и он тоже выходит из строя, но для крошечного индикаторного светодиода с очень малым током такой расклад выглядит маловероятным.</p>
<p>Теперь можно перейти и непосредственно к датчикам.</p>
<p><strong>Геркон нормально разомкнутый</strong></p>
<p><strong>НЕТ</strong></p>
<p>Если геркон не будет замыкаться от магнитного поля, то это может создать проблему в случае позднего обнаружения, например, при установке на охрану. Времени на исправление нет, а датчик не работает. Есть смысл либо постоянно контролировать датчик, либо как-то сигнализировать индикаторами о его работе.</p>
<p><strong>БОЛЬШЕ</strong></p>
<p>Сильное магнитное поле из-за близкого расположения магнита позволяет злоумышленнику что-то сделать, не размыкая геркон, например, приоткрыть дверь и просунуть туда руку с магнитом, который уже будет удерживать геркон от срабатывания.</p>
<p><strong>МЕНЬШЕ</strong></p>
<p>Срабатывание из-за изменения позиции магнита и уменьшения магнитного поля, например, из-за люфта двери, окна или подобной конструкции.</p>
<p><strong>ТАКЖЕ</strong></p>
<p>Замыкание в проводке геркона или в месте разъёма датчика, что сделает его вечно-замкнутым. Этот опасный случай намекает на включение тестовой размыкающей кнопки после всех разъёмов, непосредственно в цепь с герконом, ибо после неё может быть замыкание.</p>
<p><strong>ДРУГОЙ</strong></p>
<p>Импульс, дребезг контактов, что повлияет на срабатывание ESP. Может выйти какой-то триггерный эффект, когда от первого срабатывания плата переключается в какое-то состояние, которое отменяет быстрое второе срабатывание или похожий конфликт состояний.</p>
<p><strong>РАНО, ПОЗДНО, ПРЕЖДЕ, ПОСЛЕ</strong></p>
<p>Поскольку такой самодельный бытовой модуль сигнализации не относится к системам жесткого реального времени, то определённые отклонения допустимы. Но они могут увеличиваться из-за, например, выхода из режимов сна и подключения к WiFi, что требует много времени.</p>
<p>Теоретически, информация о причине пробуждения доступна ESP и если злоумышленник снова замкнёт геркон (например, закрыв за собой дверь, что в общем-то логично), то плата всё равно должна сработать, не доверяя текущему состоянию датчиков. Но в логику может проникнуть баг и состояние перезапишется, а плата не поймает разомкнутый геркон.</p>
<p><strong>Датчик инфракрасный</strong></p>
<p><strong>НЕТ</strong></p>
<p>Датчик может не сработать, начиная от особенностей пироэлектрического эффекта и заканчивая загадочными обстоятельствами. Учитывая относительную сложность самого датчика, его тестирование почти ничего не гарантирует, он может отказать в любой момент. Здесь может быть уместным дублирование, но появляется проблема синхронизации между датчиками, как и увеличится потребление и шанс ложных срабатываний, но это выглядит меньшим злом.</p>
<p>В конце концов, датчик наверняка можно обмануть каким-нибудь поглощающим излучение материалом или хитроумных трюком, так что в одиночку он будет защищать только в самых простых случаях.</p>
<p><strong>БОЛЬШЕ</strong></p>
<p>Напряжение на выходе больше 3.3V по каким-то причинам и ESP выгорит. Трудно сказать, насколько высок этот риск, но можно развязать его, например, оптопарой.</p>
<p>Дистанция срабатывания может быть больше чем нужно, что приведёт к постоянным или случайным ложным срабатыванием.</p>
<p>Больше срабатываний может быть также из-за случайного переключения в режим H.</p>
<p>При обслуживании сигнализации датчик будет постоянно срабатывать, мешая отладке, например, из-за одиночного светодиода для состояния всех датчиков. Есть смысл предусмотреть либо выключение такого раздражающего датчика, либо реагирование ESP на него.</p>
<p><strong>МЕНЬШЕ</strong></p>
<p>Напряжение на выходе может быть меньше, такого уровня не хватит для срабатывания или оно будет рандомным. Теоретически, можно подключить датчик к АЦП и определять уровень вручную, но трудно сказать, насколько эта идея хорошая.</p>
<p><strong>БОЛЬШЕ, МЕНЬШЕ</strong></p>
<p>Температура в помещении. Не нашёл каких-то данных о влиянии температуры на сам датчик, кроме разве что её резких скачков. Но учитывая шанс подделки, температурный диапазон его работы может быть и не очень большим, как вариант.</p>
<p><strong>ТАКЖЕ</strong></p>
<p>Ложные срабатывания на скачки температуры, сквозняки и прочее. Насчёт срабатывания датчика на огонь или дым отзывы разнятся, а эксперимент трудоёмок. Это, возможно, полезное свойство, но трудноразличимое с обычным срабатыванием. Невозможность различать разные причины его срабатывания очень сильно уменьшают полезность.</p>
<p><strong>ЗАМЕНА</strong></p>
<p>Сигнал при отсутствии движения, что без видеонаблюдения может создать много проблем и лишнего беспокойства.</p>
<p><strong>ДРУГОЙ</strong></p>
<p>На выходе импульсы с высокой частотой, при превышении некоторого значения которой должны начаться проблемы. ESP, возможно, или не увидит изменения уровня, либо увидит там рандом, либо будет ещё какая беда.</p>
<p><strong>РАНО, ПОЗДНО, ПРЕЖДЕ, ПОСЛЕ</strong></p>
<p>Любые сильные отклонения дают возможность подобраться к модулю и выключить его. С одной стороны, по исчезновению маяка можно судить о проблемах с устройством, с другой - выключение может потребоваться злоумышленнику для какой-нибудь другой цели. Например, в случае подделки ответа устройства исключить посыл сообщений с него.</p>
<p>Ещё из-за наличия в датчике настройки времени импульса можно попытаться завязать код на это время, но наличие разных режимов в самом датчике и отклонения времени создают некоторый шанс багов в этой логике.</p>
<p><strong>Плата с ESP</strong></p>
<p>А вот сам ESP32 из-за сложности своего устройства делает анализ по ключевым словам крайне проблематичным. Со стороны железа риски по большей части сходные: температура, обрыв, замыкание и дребезг контактов, отклонения сигналов по длительности, частоте, амплитуде, крутизне фронтов уровней, отказы во встроенных резисторах пинов, но их намного больше из-за насыщенного функционалом чипа и самой платы. Многие виды отказов очень проблематично обнаружить, как и защититься от них. Возможны конфликты между разными режимами платы, например, прошивка от USB и питание от БП. Добавляются проблемы от радиомодуля, который тоже может работать плохо.</p>
<p>Отсюда есть смысл попробовать другой подход, например, анализ <a href="https://en.wikipedia.org/wiki/Event_tree_analysis">ETA (Event Tree Analysis)</a> из-за возможности использования взаимоисключающих событий, что также снижает требования к пониманию причинно-следственных связей. Но здесь появляется тонкий нюанс между противоречием и противоположностью, которые в обыденности могут запросто маскироваться друг за другом и на эти грабли легко наступить.</p>
<p>Графический способ также не особо удобен, поэтому попробую в текстовой форме. В первую очередь интересует работоспособность платы как таковая.</p>
<p><strong>Плата не включилась</strong>.</p>
<p>Эта ветка может начинаться с источника питания: работает и не работает. Работоспособность должен показать светодиод питания, как БП, так и самой ESP-платы. Если БП работает, контакты в порядке и на Vin поступает питание, то проблема в самой плате. Может отказать как стабилизатор с обвязкой, так и более глубокие элементы, тут ничего не поделаешь.</p>
<p><strong>Плата включилась</strong>.</p>
<p>Состояние самого модуля неизвестно, что намекает на систему самотестирования и проверку всей периферии, что проблематично. Остаётся протестировать:</p>
<ul>
<li>Напряжение и силу тока, если таковой датчик имеется.</li>
<li>Сигнал с датчика огня.</li>
<li>Уровень температуры через терморезистор выше. В старых платах с ESP32 был встроенный датчик температуры, но в более новых его убрали.</li>
<li>Количество свободной памяти.</li>
</ul>
<p>Полезность такого тестирования из-за ограничений железа и тулчейна крайне низкая, ибо оно покрывает только самые простые случаи. Да и тестирование при первом включении не выявит всех последующих проблем: температура будет расти, а память уменьшаться. Поэтому логично мониторить показатели постоянно, отсылая уведомление ещё и по этой причине.</p>
<p>Неплохо бы получить запись лога в файл на флешку через SPIFFS, чтобы потом либо проверить его на ошибки в процессе тестирования выше, либо просматривать удалённо. Контролировать размер файла достаточно легко, но многократно повышается шанс проблем при потере питания, ибо на флешку постоянно что-то пишется. Там есть функции для её восстановления, но очень упрощённая файловая система выглядит так себе надёжной. Light-sleep флешку вроде как не отключает, но в более глубоком сне наверное появится сложность из-за её включения и выключения, хотя в доках это и не рекомендовано. В эти периоды лог должен сохраняться в память, а затем сбрасываться на файл. Отладка всего этого на таком железе выглядит как создание себе проблем.</p>
<p>Тестирование может закончиться двумя результатами: успешно и неуспешно.</p>
<p><strong>Тестирование неуспешно</strong></p>
<p>Можно подать звуковой сигнал, но появляется проблема в определении причины. К модулю можно подключить какой-нибудь небольшой LCD-дисплей, но тут полезным выглядит REST-апи на условно более безопасном HTTPS сервере. Реализация настроек и вывода информации на дисплей потребует много часов работы и войны с багами из-за ограничений в тамошних графических библиотеках, не решая проблемы связи модуля с другими устройствами.</p>
<p>Сервер у ESP использует библиотеку <a href="https://github.com/Mbed-TLS/mbedtls">mbedtls</a>, которая выглядит более-менее популярной, как и положено для инфосека, хотя насчёт возможных уязвимостей я не в курсе. Конечно же, есть много других способов связи с модулем, да и большой количество самых разных библиотек.</p>
<p>Само по себе наличие такого сервера в модуле создаёт много рисков и его работу нужно как-то сигнализировать, я остановился на отдельном светодиоде, хотя можно было бы сэкономить пин и задействовать всего один светодиод для всех режимов модуля. Здесь появляется некий риск, что светодиод погаснет, а сервер останется невыключенным, оставляя потенциальные двери для взлома, что можно проверить, например, пробным подключением клиента после выключения сервера.</p>
<p>Если сервер запустился, то проблема диагностируется через него, если нет, то без JTAG и подключения к компу связи с модулем никакой нет. Технически, провал тестирования и отказ в https-сервере могут быть несвязанными событиями, поэтому какой-то тестовой кнопкой можно отправить результат тестирования на клиент. В этом случае может оказаться полезным и дисплей.</p>
<p>Технически, ESP допускает обновление прошивки без подключения через OTA (Over The Air Updates). Но выглядит этот функционал специализированным, хорошо подходя, например, для заливки отлаженных прошивок. Если изменения и фиксы постоянны, то нужен и последовательный порт, скорость и многочисленные эксперименты, что для USB-кабеля выглядит поудобнее. Ну а если OTA не используется, то можно высвободить место на флешке, удалив неиспользуемый раздел.</p>
<p><strong>Тестирование успешно.</strong></p>
<p>Но оно пройдено только единожды. Логично делать его по таймеру и отсылать результат в обязательном порядке через какой-то промежуток времени, высчитывая дельту по той же памяти, ибо заложенные уровни выявления отклонений могут тоже отказать: их недостаточность, баги, какая-то неочевидная комбинация и т.п.</p>
<p>После включения и тестирования модуль начинает свою основную работу.</p>
<p>Один из простых способов логики охраны - состояния, которые должны сохраняться. Если модуль был в режиме охраны, а потом питания пропало и вновь появилось (его включили), то он также должен перейти в состояние охраны.</p>
<p>Preferences.h показался достаточным для этой цели. Соответственно, рождается шанс бага из-за некорректных переходов, например, из-за дребезга контактов, который вызывает сразу несколько переключений состояния.</p>
<p>Один из недостатков - юзабилити, которое очень не любит режимы из-за частой путаницы в них. Текущее состояние должно быть хорошо различимо индикаторами. Есть некий шанс вообще забыть включить модуль, поэтому может быть какой-то выносной подключаемый светодиод на выходе из периметра, призванный лишний раз напомнить об этом. С другой стороны, можно ограничиться и простыми тексто-знаковыми напоминаниями.</p>
<p>Соответственно, модуль может оказаться по крайней мере в двух корректных состояниях, непосредственно охраны и наблюдения за датчиками без срабатывания оповещений. С другой стороны, какая-то часть датчиков, например, огня, газа и отдельные датчики периметра (входных дверей, как вариант) могут срабатывать в обоих режимах, так что границы между ними размываются, меняется лишь способ оповещения.</p>
<p>При включении модуль должен как-то перейти в одно из состояний.</p>
<p><strong>Состояние модуля неопределённое</strong></p>
<p>Индикаторы не показывают ни один из корректных режимов, могут быть проблемы как с чтением настроек, так и с логикой работой с отказами. Без дисплея можно подстраховаться, например, звуковым сигналом, чтобы понять, прочиталась ли конфигурация на флешке. Если его нет, то переход в какое-то из состояний не был, управление до него не дошло.</p>
<p>Удобными выглядят несколько звуковых сигналов подряд, по количеству и тональности которых можно судить о выполняемой логике. Звук помогает лучше уловить случайную перезагрузку или ошибку, которая запросто может ускользнуть при индикации светодиодом или дисплеем.</p>
<p><strong>Модуль перешёл в наблюдение</strong></p>
<p>В этом состоянии о работе модуля можно судить по индикаторам, которые могут работать и не работать в т.ч. отслеживая работу датчиков. В последнем случае диагностика сложна и как-то подстраховаться тут проблематично.</p>
<p>Как было отмечено выше, часть датчиков может срабатывать в этом режиме, что требует контроля за начальным их состоянием. Однако способ оповещения меняется, использование сети может быть неудобным. Если датчиков немного, то выручит простой светодиод или звук, если много, то дисплей или использование сети выглядит необходимостью. С другой стороны, датчик может отказать позже, поэтому устройство также должно оповещать о поломке. Итого, датчики могут не работать и работать.</p>
<p>Если датчики работают корректно, то нет гарантий, что сработает оповещение на часть из них. Оповещение может быть самое разное, вспомним тот же ревун, включать который каждый раз при перезагрузке или включении устройства невозможно. Протестировать те же герконы без механического размыкания в общем-то тоже невозможно. Остаётся вариант тестовой кнопки, размыкающей цепь того же геркона или подобное тестирование по необходимости.</p>
<p>Если оповещение не срабатывает, то нужно разбираться в причинах, если срабатывает, то тут появляется проблема и в мониторинге самого модуля. В режиме охраны и удалённого контроля для результатов периодического самотестирования можно использовать тот же канал, что и для оповещений. В режиме наблюдения модуль может включить оповещение в случае провала самотестирования, но сложно судить, происходит ли это тестирование вообще как таковое, что очень большая проблема этого режима.</p>
<p>Есть вариант отсылать результаты на какое-нибудь устройство. С таким спамом можно смириться, но отключение сети, которое запросто может быть в этом режиме будет триггерить сохранение событий на флешку, а если его выключить, то они могут быть утеряны. Вот здесь полезность дисплея очень возрастает, ибо он может выводить результаты последнего тестирования, когда как светодиод, звук в этой роли не годятся. Дисплей и настройка возможности отсылки на устройство выглядят более удобным сочетанием.</p>
<p>Рассмотрим другой вариант событий.</p>
<p><strong>Модуль перешёл в охрану</strong></p>
<p>По кнопке либо при чтении сохранённого состояния. Основная задача этого режима - это, конечно же, оповещения. Проще всего использовать мессенджеры, библиотек очень много всяких разных.</p>
<p>Работа датчиков в этом режиме уже не видна, любое изменение состояния должно сопровождаться оповещением. Во многих охранных системах в корпус встраивается микропереключатель, вероятно, где-то защита основана на датчиках Холла, так что оповещение отсылается и при вскрытии корпуса. Но полезность такой защиты очень условна, ибо в худшем сценарии злоумышленник всегда знает внутреннее устройство модуля, такие примитивные системы защиты не выглядят надёжными. С другой стороны, она достаточно проста.</p>
<p>Для оповещений основной риск от миллионов миллиардов проблем сети. Логика оповещений имеет сходство с event-driven application, как одного из видов потоковых систем. Для предотвращения утери событий в них используются всякие техники: RBML с сохранением полученного сообщения, SBML для отправленного и гибридный HML, сохраняющий его дважды, как и подобные. В случае ESP один из самых простых способов - это запись на флешку через файловую систему SPIFFS. При выключении питания и последующим включении можно проверить наличие неотправленных сообщений и отправить их, как и повторять отправку в случае проблем сети.</p>
<p>Здесь появляется частный случай - спам оповещениями из-за программных ошибок, некорректной работы датчиков и самых разных причин. В реакцию на датчики любая порядочная сигнализация закладывает настраиваемый таймаут, но он может по каким-то причинам не сработать или сработать не так. Как вариант, самое слабое звено - это esp-шный таймер, на который опираются все таймауты.</p>
<p>С другой стороны, программное ограничения и проверка событий на идентичность с подсчётом их количества создают шансы потерять важное срабатывание. Если спам не тратит лимиты сервиса, то на устройстве можно использовать поиск среди спама, ибо все события доставляются. А вот гарантировать такую доставку в случае более сложной логики работы с событиями может быть проблематичным.</p>
<p>К сожалению, ветка событий выше не позволяет проследить множество других видов отказов. А любое добавление защиты от отказов добавляет и отказы в самой этой защите, усложняет устройство, повышает шанс что-то замкнуть или соединить не так.</p>
<p>Вспомним, например, крайне популярное явление для embedded - зависание микроконтроллера, что в общем случае требует сторожевого таймера. В ESP их несколько, но судя по материалам в сети срабатывают они с переменным успехом, намекая на внешние схемы контроля. Встречал такие даже на 555-ом таймере, как и на специализированных микросхемах, но пока не определился с выбором.</p>
<p>Есть сложность и с корректным поддержанием соединения. Предположим, что Wi-Fi по каким-то причинам отваливается и переподключение либо не срабатывает, либо ESP считает его подключенным, что на самом деле не так.</p>
<p>В этом случае можно считать количество неудачных отправок или отправленных сигналов маяка, а затем пытаться перезагрузить микроконтроллер при достижении какого-то лимита. Вероятно, можно определять более низкоуровневым апи сам факт наличия домашней сети, исключая проблемы с роутером, но трудно сказать, насколько это апи надёжно.</p>
<p>Однако поскольку охранная логика опирается на состояния, может быть запутанной с различными условиями и багами, то лишняя перезагрузка повышает шанс получить при последующем включении невалидное состояние из-за багов или каких-то других проблем. Хотя в embedded есть подход с периодической перезагрузкой устройства, но высокая сложность IoT-платформы и логики заставляют лишний раз задуматься при её использовании.</p>
<p>Эти и другие нештатные ситуации лучше обрабатываются анализом <a href="https://en.wikipedia.org/wiki/Fault_tree_analysis">FTA (Fault tree analysis)</a>, но без достаточного опыта работы с ESP и с электроникой как таковой очень сложно адекватно выявлять причинно-следственные связи. Конечно же, никто не отменял и классическое тестирование: граничные значения в классах эквивалентности, таблицы решений, state-transition testing, хорошо укладывающийся в логику работы состояний охраны, как и прочие инструменты, способные выявить проблемы и баги. Но это уже выходит за рамки темы, поэтому завершаем этот наивный эксперимент охранного модуля.</p>
<p>Какие итоги можно подвести. С моей позиции DIY-электронщика работа с ESP32 понравилась, ибо у меня пока нет каких-то специфических задач, в которые можно упереться архитектурой и возможностями платы.</p>
<p>Благодаря популярности почти все проблемы я решал гуглом достаточно быстро, библиотек много, функционала тоже. Качество самих плат варьируется от производителя к производителю, но моя особых проблем не вызвала, хотя выглядит явно подделкой под оригинал. В сети много сетований на самые разные проблемы ESP-шных платформ, но и у других не меньше.</p>
<p>Дальнейшая моя работа с этой платформой сильно зависит от беспроблемного использования других языков в тулчейне, но, судя по всему, всё к этому и идёт. Однако здесь нужно учитывать и конкурентов. Было бы очень хорошо использовать множество разных платформ, каждую под свою задачу, что хорошо согласуется с непреложным законом &quot;каждой задаче - свой инструмент&quot;. Но реалии суровы и мне нужно выбрать кого-то одного для работы.</p>
<p>Неплохим аналогом смотрятся новые маломощные платы от Raspberry, а некоторые вроде Raspberry Pi Zero 2 W выглядят как пропущенное звено, которое я искал выше в переходе от отладочных плат к микроконтроллерам. С другой стороны, ESP должен чем-то ответить на такую попытку захвата их рыночной ниши, так что последующие улучшения линейки могут сделать изучение плат Raspberry бессмысленным, а может и наоборот.</p>
<p>Возможно, во время долгого акцента на мощном железе со стороны Raspberry, тулчейн и SDK у Espressif за это время улучшался, что скорее всего создаст значимую разницу между ними по инструментам. Даже если новые платы будут дешевле и лучше по характеристикам, то этого может быть недостаточно: популярность, коммьюнити, наличие библиотек, примеров, проектов и прочие факторы также влияют на преимущества. Нежелание или невозможность развивать тулчейн для новых Raspberry-плат может оставить выгодным ESP в домашнем хозяйстве, даже мирясь с его недостатками.</p>
<p>С другой стороны, платформа ESP долгие годы оставалась монополистом в DIY-электронике, что позволяло на некоторые проблемы закрывать глаза и копить технический долг, ибо в условиях монополии выбора у массового покупателя не было.</p>
<p>Теперь же в условиях конкуренции малейший недостаток будет помогать конкуренту продвигаться на рынке, а в сети достаточно много жалоб на ESP-шные проблемы, начиная от железа и заканчивая тулчейном с фреймворком. По этим проблемам сложно судить об их критичности и влиянии на будущее самого ESP, ибо проблемы есть у всех платформ, но такая мопонолия в прошлом сама по себе создаёт риск вложиться временем в то, что будет улучшено конкурентным аналогом. Всё-таки любой новый продукт может опираться на ошибки предыдущих. С другой стороны, при наивном исправлении этих ошибок можно наделать новых, ещё более проблемных, особенно при последующем усложнении и обрастании функционалом.</p>
<p>Для DIY-разработки критически важен функционал и нашпигованность платы разными возможностями, позволяющими быстро решить задачу несколькими способами, что экономит время и открывает дорогу к сложным проектам. По функционалу ESP догнать здесь сложно, ибо там напихано всего что только можно, да и скорее всего будет напихиваться и дальше.</p>
<p>Но конкурент может использовать преимущества в различных нефункциональных требованиях, например, в надёжности. Ради этого очень важного преимущества можно пожертвовать как функционалом, так и потратить больше времени на разработку и изучение аналога. Однако популярность никто не отменял: в дикой природе обитает много сходных по цене и технически лучших аналогов ESP, но без популярности и большого коммьюнити трудоёмкость разработки на таких платах сводит все преимущества на нет.</p>
<p>Все эти платы достаточно дёшевы в сравнении, например, с тем же STM32 сходных характеристик. С одной стороны, stm-мы почти промышленный стандарт, поддержка различной периферии, менее проблемное использование сторонних системных языков и прочие бонусы. С другой стороны, в домашнем IoT-строении задачи совершенно иные, сильно отличающиеся от промышленных, а вкладывать время ради более редких или периодических кейсов выглядит расточительным. А в условиях сочетания с другими IT-навыками скорее невозможным. Итого, пока я не уверен, что STM32 мне нужен при всей его популярности.</p>
<p>Кроме того, RISC-V, который используется в части плат Espressif выглядит намного более удобным для IoT-рынка с его огромным количеством небольших компаний, часть из которых будут эксплерентами в рыночной конкурентной борьбе. Новые экспериментальные продукты с неопределённой прибылью могут плохо сочетаться с закрытыми архитектурами типа ARM. Также нельзя исключать и вероятное стремление к технологической независимости Китая. Итого, доминирование ARM в промышленности и в мобайле не означает, что рынок IoT, взрывной рост которого ожидается в ближайшие годы будет завязан на эту же архитектуру. Возможное изменение рынков вносит риски для обучения, создавая шанс потратить своё время впустую.</p>
<p>Как видно, не так-то и просто выбрать себе плату для вспомогательных IoT-задач, а при таком выборе запросто может упустить какой-нибудь нюанс. Например, температурный минимум в -20°C в даташитах Raspberry выглядит как-то подозрительно. Придётся немного подождать, почитать, понаблюдать, да подумать.</p>
</div>
    </div>
</article>
<div class='navigation-pages btn-toolbar justify-content-center mb-2' role='navigation'>
    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1'
       href='/pages/java-geoinformatics-with-geotools.html' role='button' rel="prev"> <span
            class='navigation-pages-link-icon mdi mdi-chevron-left'></span> Увлекательная геоинформатика с GeoTools</a>
    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1' href='/index.html'
       role='button' rel="first">
        <span class='navigation-pages-link-icon mdi mdi-home'></span> Главная</a>

    
    <a class='navigation-pages-link btn mb-2 mx-0 mx-sm-1'
       href='/pages/psychology-in-software-architect.html' role='button' rel="next">Влияние психологии на архитектуру программ <span
            class='navigation-pages-link-icon mdi mdi-chevron-right'></span></a>
    
</div>
        </div>
        <div class='col-lg-3 sidebar-right'>
            <div class='section' id='section-sidebar-right'>
    <div class='card sidebar-container post-labels'>
        <div class='card-header sidebar-container-header post-labels-header'>
            <span class='post-labels-header-icon mdi mdi-tag-outline'></span>
            Метки <span class='text-clarification'>(и кол-во статей)</span>
        </div>
        <div class='sidebar-container-content post-labels-content'>
            <div class='list-group list-group-flush'>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/dart.html'>Dart<span class='badge' style='min-width:40px;'>2</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/dlang.html'>Dlang<span class='badge' style='min-width:40px;'>3</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/groovy.html'>Groovy<span class='badge' style='min-width:40px;'>5</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/javafx.html'>JavaFX<span class='badge' style='min-width:40px;'>6</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/arhitektura_po.html'>Архитектура ПО<span class='badge' style='min-width:40px;'>10</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/metodologija.html'>Методология<span class='badge' style='min-width:40px;'>2</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/raznoe.html'>Разное<span class='badge' style='min-width:40px;'>1</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/ekonomika.html'>Экономика<span class='badge' style='min-width:40px;'>3</span></a>
                
                <a class='list-group-item list-group-item-action d-flex justify-content-between align-items-center ' href='/tags/elektronika.html'>Электроника<span class='badge' style='min-width:40px;'>1</span></a>
                
            </div>
        </div>
    </div>
    <div class='card sidebar-container in-progress-articles'>
       <div class='card-header sidebar-container-header in-progress-articles-header'>
           <span class='mdi mdi-calendar-clock'></span>
            В процессе написания
       </div>
       <div class='sidebar-container-content post-labels-content in-progress-articles-content'>
               <ul class='list-group'>
				   <li class='list-group-item align-items-center text-muted'>Нет статей</li>
               </ul>
       </div>
    </div>
    <div class='card mb-3 sidebar-container links-contacts'>
        <div class='card-header sidebar-container-header links-contacts-header'>
            <span class='mdi mdi-open-in-new'></span>
            Девлоги текущих проектов
        </div>
        <div class="list-group sidebar-container-content">
			<a class='link-contact list-group-item list-group-item-action' rel="me" href='https://www.youtube.com/@initkfs'>Youtube (готовится)</a>
		</div>
    </div>
    <div class='page-up-wrapper'>
        <button class='btn d-none d-lg-block' id='page-up-trigger' type='button'><span
                class='mdi mdi-arrow-up'></span></button>
    </div>
</div>
        </div>
    </div>
</div>
<footer class='page-footer'>
    <div class='container'>
        <div class='row'>
            <div class='col-md-12'>
                <div class='card'>
    <div class='card-body'>
        <p class="text-danger">Сайт в процессе тестирования.</p>
        <small><span class='blog-info-footer'>Всего статей: 24. Блог - исследовательский, статьи отражают лишь субъективное мнение автора.</span> <span>&#169; <span id='copyright-date'></span>, Константин Фирсов.</span></small>
        
        <div class='blog-additional-links d-flex justify-content-center'>
        <div class='blog-rss'><a class='blog-rss-item blog-icon-clickable'
                                 href='/rss-all.xml'><span
                class='mdi mdi-rss-box blog-icon-rss'></span></a></div>
        </div>
        <div class='text-danger' id='js-fail-block'>
            <noscript>
                <small>JavaScript отключен в браузере, функционал сайта ограничен.</small>
            </noscript>
        </div>
    </div>
</div>
<script type='application/ld+json'>
    {
        "@context": "http://www.schema.org",
        "@type": "person",
        "name": "initkfs",
        "jobTitle": "",
        "url": "/index.html"
    }
</script>
            </div>
        </div>
    </div>
</footer>
<div class='mobile-up-wrapper text-center'>
    <button class='btn d-lg-none' id='mobile-page-up-trigger' type='button'><span
            class='mdi mdi-arrow-up'></span> Вверх
    </button>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" 
integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script crossorigin='anonymous' integrity='sha512-TPh2Oxlg1zp+kz3nFA0C5vVC6leG/6mm1z9+mA81MI5eaUVqasPLO8Cuk4gMF4gUfP5etR73rgU/8PNMsSesoQ=='
        src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js'></script>

<script crossorigin='anonymous' integrity='sha512-WW8/jxkELe2CAiE4LvQfwm1rajOS8PHasCCx+knHG0gBHt8EXxS6T6tJRTGuDQVnluuAvMxWF4j8SNFDKceLFg=='
        src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.min.js'></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.2/timeago.full.min.js" integrity="sha512-wb3lqal2VtYhmlPAr232VP+Zus676CFAEYdywxIUSxG6F/X9WhN6SpREkWUdwBvMpd6gCKuKTGHhdum6m1wOvQ==" crossorigin="anonymous"></script>

<script crossorigin='anonymous' integrity='sha512-9khQRAUBYEJDCDVP2yw3LRUQvjJ0Pjx0EShmaQjcHa6AXiOv6qHQu9lCAIR8O+/D8FtaCoJ2c0Tf9Xo7hYH01Q=='
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>

<script crossorigin='anonymous' integrity='sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw=='
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" ></script>

<script>
var problemScripts = [];
if (typeof jQuery === 'undefined') {
    problemScripts.push("jquery");
}

   if (typeof Prism === 'undefined'){
    problemScripts.push("prism.js");
   }
   
if (typeof Popper === 'undefined') {
    problemScripts.push("popper.js");
}

if (typeof timeago === 'undefined') {
    problemScripts.push("timeago.js");
}

if (typeof window.bootstrap === 'undefined') {
    problemScripts.push("bootstrap.js");
}

if (problemScripts.length > 0) {
    var message = "Ошибка загрузки JavaScript: " +
        problemScripts.join(",") +
        "." +
        " Возможные причины: блокировщик рекламы, проблемы с сетью, устаревший браузер. Может не работать дополнительный функционал.";

    var failInfoBlock = document.createElement("small");
    failInfoBlock.innerHTML = message;

    var mainFailBlock = document.getElementById("js-fail-block");
    if (!mainFailBlock) {
        console.error(message);
    } else {
        mainFailBlock.appendChild(failInfoBlock);
    }   
}
</script>
<script src="/assets/dev/js/main.js"></script>
</body>
</html>



